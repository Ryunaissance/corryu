<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>SMH Corr 업데이트</title>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body { background: #0f172a; color: #e2e8f0; font-family: -apple-system, sans-serif;
       min-height: 100vh; display: flex; align-items: flex-start; justify-content: center;
       padding: 32px 16px; }
.card { background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08);
        border-radius: 16px; padding: 28px; max-width: 520px; width: 100%; }
h1 { font-size: 1.2rem; font-weight: 700; margin-bottom: 6px; }
.sub { color: #64748b; font-size: 0.82rem; margin-bottom: 24px; line-height: 1.5; }
.btn { display: inline-block; padding: 12px 28px; border-radius: 10px; border: none;
       cursor: pointer; font-size: 0.95rem; font-weight: 700; transition: background 0.15s; }
#btn-start { background: #3b82f6; color: #fff; width: 100%; }
#btn-start:hover:not(:disabled) { background: #2563eb; }
#btn-start:disabled { opacity: 0.4; cursor: not-allowed; }
#btn-goto  { background: #10b981; color: #fff; width: 100%; margin-top: 12px; display: none; }
#btn-clear { background: rgba(239,68,68,0.15); color: #f87171; border: 1px solid rgba(239,68,68,0.25);
             width: 100%; margin-top: 8px; font-size: 0.8rem; padding: 8px; display: none; }
.progress-wrap { margin: 18px 0 6px; background: rgba(255,255,255,0.06); border-radius: 6px;
                 height: 8px; overflow: hidden; display: none; }
.progress-bar  { height: 100%; background: #3b82f6; border-radius: 6px;
                 transition: width 0.3s; width: 0%; }
#status { font-size: 0.82rem; color: #94a3b8; margin-bottom: 8px; min-height: 18px; }
#log    { font-size: 0.75rem; color: #475569; max-height: 220px; overflow-y: auto;
          font-family: monospace; line-height: 1.6; margin-top: 14px; display: none; }
.tag { display: inline-block; padding: 2px 8px; border-radius: 5px; font-size: 0.72rem;
       font-weight: 700; margin-right: 4px; }
.tag-ok  { background: rgba(16,185,129,0.15); color: #34d399; }
.tag-err { background: rgba(239,68,68,0.15);  color: #f87171; }
.cached-info { background: rgba(251,191,36,0.08); border: 1px solid rgba(251,191,36,0.2);
               border-radius: 8px; padding: 12px; margin-bottom: 16px;
               font-size: 0.8rem; color: #fde68a; display: none; }
</style>
</head>
<body>
<div class="card">
  <h1>SMH Corr 업데이트</h1>
  <p class="sub">주식시장 780종목의 SMH 상관계수를 Yahoo Finance에서 계산해<br>
                 브라우저 localStorage에 저장합니다.<br>
                 완료 후 index.html에서 SMH Corr 칼럼이 채워집니다.</p>

  <div class="cached-info" id="cached-info"></div>

  <div id="status">준비 중...</div>
  <div class="progress-wrap" id="progress-wrap">
    <div class="progress-bar" id="progress-bar"></div>
  </div>

  <button class="btn" id="btn-start" onclick="startFetch()">SMH Corr 계산 시작</button>
  <button class="btn" id="btn-goto"  onclick="location.href='index.html'">→ 대시보드로 이동</button>
  <button class="btn" id="btn-clear" onclick="clearData()">저장된 SMH Corr 데이터 삭제</button>

  <div id="log"></div>
</div>

<script>
const TICKERS = ["VOO","IVV","SPY","VTI","IWF","SPYM","VIG","VO","RSP","ITOT","IWD","IVW","SCHX","QUAL","IVE","VV","IWB","DIA","SPYG","JEPI","DFAC","SCHB","DGRO","SPYV","DYNF","OEF","ACWI","IUSG","IUSV","FNDX","USMV","VOOG","MTUM","IWP","IWV","DFUS","VOT","SPHQ","DGRW","ESGU","SCHV","VONV","MOAT","SPMO","SPTM","ESGV","AVUS","XLG","DUHP","DFAU","PBUS","MGC","SPUT","PRF","FDVV","FVD","BUFR","FTCS","QYLD","IOO","RWL","SPYI","GRID","THRO","VONE","JQUA","BBUS","JGLO","URTH","FELC","DIVO","TCAF","VOOV","DLN","BKLC","DSI","SCHK","OMFL","VTHR","HELO","SUSA","XT","IWX","FV","ACWV","AOR","PTLC","IMCG","USMC","XYLD","LRGF","AOA","IYY","USCA","DCOR","WTV","SPGP","SNPE","SPYX","COWG","PABU","EQWL","NULG","TSPA","USCL","QGRO","IWL","KLMN","FTHI","JMOM","FLQL","FLQM","USPX","ROBO","RPG","QUS","EUSA","DTD","PWB","IMCB","QVML","QDPL","FDLO","EPS","DIVB","NTSX","TDVG","FTGS","USXF","ILCV","FQAL","ILCB","FNDB","CATH","DUSA","SUSL","AVLC","STRV","EFIV","EIS","BALI","MODL","DSPY","OUSA","PFM","AOK","IUS","KOKU","YYY","XVV","JVAL","FDRR","EQL","HEWJ","USSG","CFA","CSM","DFVX","AVSU","WTPI","SIZE","LRGE","BBH","USMF","NUMG","VFMV","LRGG","VALQ","ZECP","EDOW","FMAG","IPAY","CWS","MAXJ","DMAX","BUL","SMAX","DWUS","LGRO","KRMA","AGZD","DWAW","RFDA","DTEC","TOLL","GTR","STXD","AVMA","NULC","SPXV","EAOA","MMAX","TJAN","EAOR","IEDI","RFFC","TWOX","SDTY","SPYH","QUSA","MOTE","NDVG","ZVOL","BELT","QQJG","PSWD","AGRH","EKG","SPAM","FB","GGUS","GPIX","GSEW","GSLC","GSUS","GUSA","JUST","SPHD","ESMV","LGLV","SCHG","VONG","MGK","IWY","JGRO","SSO","FBCG","UPRO","FELG","ILCG","NUGO","QGRW","TGRT","WINN","UDOW","DDM","AVUQ","GROZ","GK","EGUS","NWLG","BGRO","QQQ","VUG","VGT","XLK","SMH","SOXX","IYW","FTEC","BAI","IGM","IGV","IXN","RSPT","TDIV","QTUM","XSD","FTXL","XNTK","NVDY","PSI","GARP","CHAT","SOXQ","CSHI","IETC","SIXG","PTF","CHPY","AGIX","AIS","TCAI","GPTY","FMET","CHPS","SOXY","WAR","GTEK","GPIQ","QQQM","JEPQ","TQQQ","SOXL","QLD","CIBR","ONEQ","QQQI","AIQ","ARKK","TSLL","NVDL","MAGS","TECL","BOTZ","JTEK","SKYY","ARTY","HACK","USD","BULZ","ARKW","ULTY","QDTE","BUG","ROM","IHAK","NVDU","FNGO","TECB","WTAI","QQQH","THNQ","QTOP","MSTX","METV","WCLD","QQMG","LOUP","SHOC","OGIG","XAIX","WCBR","MAGX","QBIG","UBOT","WISE","BIGY","FEAT","IDAT","IVRS","FIVY","VERS","UCYB","SKYU","CLOD","ARKQ","XLF","DVY","RDVY","VFH","SPYD","FDL","KBWB","JAVA","KRE","IYF","FNCL","FXO","IYG","RPV","CLOA","KBE","DHS","OMAH","IXG","IAT","KIE","NUMV","IAK","KBWP","HYIN","BETZ","BPAY","AAUM","FAS","UYG","DPST","BNKU","ARKF","FINX","VTV","SCHD","VYM","XLI","VOE","SDY","ITA","PAVE","NOBL","MGV","AVLV","VLUE","PVAL","PPA","SHLD","VIS","XAR","IFRA","FELV","IYJ","NULV","MISL","PWV","IYT","IMCV","JETS","RSPN","ONEY","ONEV","DJD","AIVL","CDL","VOLT","VSDA","GDIV","RSHO","FLJH","IDEF","NATO","TBLU","RSPE","MADE","AQWA","MAGA","FDHT","HVAC","HWAY","EATZ","DFEN","UXI","XLC","PFF","VOX","PGX","FCOM","IYZ","PNQI","NERD","ARVR","VEA","IEFA","VXUS","EFA","VT","SCHF","VEU","IXUS","SPDW","VGK","EFV","IDEV","FNDF","EWJ","DFIV","AVDV","VYMI","BBJP","DFAI","AVDE","SCZ","DFIC","IQLT","ESGD","DFAX","VSS","JIRE","BBCA","EFG","EZU","IGF","VPL","BBEU","VIGI","ACWX","DBEF","IDV","FENI","IEUR","HEFA","DXJ","BBAX","BBIN","VSGX","EFAV","DIHP","SCHC","DFIS","FEZ","DISV","LVHI","EUFN","EWC","IVLU","IMTM","FNDC","GCOW","EWU","FLJP","PXF","CWI","EWW","IPAC","HDEF","IHDG","ICLN","EPP","SCHY","EWP","HEDJ","EWG","IEV","EWL","AOM","TAN","EWA","DDWM","FGD","SDIV","IGRO","AVIV","CGW","DLS","FLGB","PID","GWX","FDD","ARGT","SPEU","GII","DOL","IQDG","EWJV","DBEU","DMXF","DWM","NUDM","EWI","HEZU","FLCA","DTH","EPOL","ISCF","AVNM","DWX","IDOG","FEP","NTSI","IBND","DNL","DDLS","BIDD","AVSD","FLKR","DFJ","EWQ","PDN","CCNR","FLBR","EWD","IDLV","EWN","PICB","DAX","PIO","PPIE","WDIV","FJP","EMHC","AVDS","FAN","SCJ","EDEN","PBD","TOLZ","IGBH","DIM","SDG","DFE","IEUS","JPXN","EWO","DEW","NIHI","EUSC","FLEE","FGM","FKU","XC","ENZL","EUDG","EXUS","EIRL","DVYA","DBEZ","FLEU","AIVI","FRNW","ENOR","AADR","EWUS","AVNV","OEUR","DWMF","EFNL","PTEU","FPA","RNRG","EWK","RBLD","BJK","FDTS","EUDV","EAOM","RFEU","IWTR","EFRA","IPAV","FPXE","ITOL","WBAT","TINT","GSEU","GSIE","GSJY","GLOV","EURL","EZJ","UPV","IJH","IJR","IWM","VB","IWR","VBR","VXF","MDY","AVUV","VBK","SCHA","SPMD","IWS","SPSM","VTWO","DFUV","SCHM","DFAT","DFAS","IWO","IWN","SDVY","FNDA","IJK","AIRR","IJJ","XBI","IJS","DFSV","IJT","VFLO","XMMO","ICVT","FMDE","XMHQ","CWB","SLYV","FESM","DON","SLYG","CALF","VIOO","SMLF","IVOO","ITB","RDVI","PRFZ","MDYG","MDYV","AVSC","JMEE","SMMD","XSMO","ESML","FSMD","PHO","DES","BBMC","FIW","REGL","RWJ","VIOV","TMSL","IVOG","BIZD","USVM","RSSL","RYLD","IWC","VTWG","NUSC","IVOV","FPX","ARKG","RWK","RDIV","OUSM","ISCG","QQQJ","VIOG","EZM","WSML","ARKX","AVGE","VFVA","EQAL","SPHB","ROBT","EES","SMDV","BBSC","PBW","BKMC","IWMI","ISCV","XSVM","QCLN","JPSE","VFMF","GRPM","AVMV","VFQY","SMOT","KBWD","PTMC","QVMM","DGRS","UFO","XJH","PSCT","DRIV","RFG","AVMC","SMMV","AVGV","ISCB","CSB","XSHQ","XSLV","BFOR","SMIZ","SVAL","IDRV","XHE","IDNA","PSCH","ELFY","SBIO","XJR","AIEQ","ACES","FITE","HIPS","XHS","XSHD","HTEC","GNOM","IWMW","MMSC","HEAL","KSEP","SAEF","PSCF","TOKE","PSCU","QSML","ESIX","VICE","UPGR","IBRN","GRPZ","ARKT","WDNA","BEDZ","QMID","GSSC","XMLV","LVHD","SMLV","TNA","UWM"];

const RANGE = 'max';   // 상장일부터 전체 이력 사용 (5y → max)
const MIN_MONTHS = 24;
const CONCURRENCY = 6;
const LS_KEY = 'corryu_smh_corr';
const LS_META_KEY = 'corryu_smh_corr_meta';

let running = false;

// ── 유틸 ──────────────────────────────────────────────
function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

function pearson(xs, ys) {
  const n = xs.length;
  if (n < 2) return NaN;
  let mx = 0, my = 0;
  for (let i = 0; i < n; i++) { mx += xs[i]; my += ys[i]; }
  mx /= n; my /= n;
  let num = 0, dx2 = 0, dy2 = 0;
  for (let i = 0; i < n; i++) {
    const dx = xs[i] - mx, dy = ys[i] - my;
    num += dx * dy; dx2 += dx * dx; dy2 += dy * dy;
  }
  return num / Math.sqrt(dx2 * dy2);
}

function pairwiseReturns(pricesA, pricesB) {
  // pricesA/B: {YYYY-MM: price}
  const dates = Object.keys(pricesA).filter(d => d in pricesB).sort();
  const retA = [], retB = [];
  for (let i = 1; i < dates.length; i++) {
    const pa0 = pricesA[dates[i-1]], pa1 = pricesA[dates[i]];
    const pb0 = pricesB[dates[i-1]], pb1 = pricesB[dates[i]];
    if (pa0 && pa1 && pb0 && pb1) {
      retA.push((pa1 - pa0) / pa0);
      retB.push((pb1 - pb0) / pb0);
    }
  }
  return [retA, retB];
}

// URL 우선순위: Vercel proxy(동일 origin) → 직접 → corsproxy.io
function makeUrls(ticker) {
  const q = `range=${RANGE}&interval=1mo&includeAdjustedClose=true`;
  const tk = encodeURIComponent(ticker);
  const yf1 = `https://query1.finance.yahoo.com/v8/finance/chart/${tk}?${q}`;
  const yf2 = `https://query2.finance.yahoo.com/v8/finance/chart/${tk}?${q}`;
  return [
    `/api/yf?ticker=${tk}&range=${RANGE}&interval=1mo`,  // Vercel 서버사이드 프록시 (1순위)
    yf1,
    yf2,
    `https://corsproxy.io/?${encodeURIComponent(yf1)}`,
  ];
}

function parseYfChart(data) {
  const result = data?.chart?.result?.[0];
  if (!result) return null;
  const ts  = result.timestamp;
  const adj = result.indicators?.adjclose?.[0]?.adjclose
           || result.indicators?.quote?.[0]?.close;
  if (!ts || !adj) return null;
  const prices = {};
  for (let i = 0; i < ts.length; i++) {
    if (adj[i] != null) {
      const d = new Date(ts[i] * 1000);
      prices[d.getUTCFullYear() + '-' + String(d.getUTCMonth()+1).padStart(2,'0')] = adj[i];
    }
  }
  return Object.keys(prices).length >= MIN_MONTHS ? prices : null;
}

// 첫 번째 성공한 데이터 소스를 기록 (UI 표시용)
let _dataSource = null;

async function fetchMonthly(ticker) {
  const urls = makeUrls(ticker);
  for (const url of urls) {
    for (let attempt = 0; attempt < 2; attempt++) {
      try {
        const r = await fetch(url);
        if (r.status === 429) { await sleep(3000 * (attempt + 1)); continue; }
        if (!r.ok) break;
        const data = await r.json();
        const prices = parseYfChart(data);
        if (prices) {
          if (!_dataSource) {
            _dataSource = url.startsWith('/api/') ? 'Vercel 프록시' : url.includes('corsproxy') ? 'corsproxy.io' : 'Yahoo Finance 직접';
            log(`데이터 소스: <b>${_dataSource}</b>`);
          }
          return prices;
        }
        break;
      } catch(e) {
        await sleep(500);
      }
    }
  }
  return null;
}

function log(msg) {
  const el = document.getElementById('log');
  el.style.display = 'block';
  el.innerHTML += msg + '<br>';
  el.scrollTop = el.scrollHeight;
}

function setStatus(msg) { document.getElementById('status').textContent = msg; }
function setProgress(done, total) {
  document.getElementById('progress-bar').style.width = (done/total*100) + '%';
}

// ── 초기화 ──────────────────────────────────────────
window.onload = function() {
  const cached = localStorage.getItem(LS_KEY);
  const meta   = localStorage.getItem(LS_META_KEY);
  if (cached && meta) {
    try {
      const m = JSON.parse(meta);
      const n = Object.keys(JSON.parse(cached)).length;
      const el = document.getElementById('cached-info');
      el.style.display = 'block';
      el.innerHTML = `저장된 SMH Corr 데이터 있음: <b>${n}종목</b> · 업데이트: ${m.date || '?'}<br>
                      다시 계산하려면 아래 버튼을 누르세요.`;
      document.getElementById('btn-goto').style.display = 'block';
      document.getElementById('btn-clear').style.display = 'block';
      document.getElementById('btn-start').textContent = '다시 계산';
    } catch(e) {}
  }
  setStatus('시작 버튼을 눌러 계산을 시작하세요.');
};

function clearData() {
  if (!confirm('저장된 SMH Corr 데이터를 삭제할까요?')) return;
  localStorage.removeItem(LS_KEY);
  localStorage.removeItem(LS_META_KEY);
  location.reload();
}

// ── 메인 ─────────────────────────────────────────────
async function startFetch() {
  if (running) return;
  running = true;
  document.getElementById('btn-start').disabled = true;
  document.getElementById('btn-goto').style.display = 'none';
  document.getElementById('btn-clear').style.display = 'none';
  document.getElementById('cached-info').style.display = 'none';
  document.getElementById('progress-wrap').style.display = 'block';
  document.getElementById('log').innerHTML = '';

  // 1. SMH 먼저 (연결 테스트 겸)
  setStatus('SMH 데이터 다운로드 중...');
  log('Yahoo Finance 직접 접근 → CORS proxy 순으로 시도합니다.');
  const smhPrices = await fetchMonthly('SMH');
  if (!smhPrices) {
    setStatus('❌ SMH 데이터 다운로드 실패.');
    log('<span class="tag tag-err">실패</span> /api/yf (Vercel 프록시) + Yahoo Finance 직접 + corsproxy.io 모두 실패.<br>'
      + '→ Vercel 재배포 후 재시도하거나, PC에서 <code>python patch_r_anchor_qqq.py</code> 실행을 권장합니다.');
    document.getElementById('btn-start').disabled = false;
    running = false;
    return;
  }
  log(`<span class="tag tag-ok">SMH</span> ${Object.keys(smhPrices).length}개월 데이터 로드 완료`);

  // 2. 780 종목 병렬 fetch
  const total = TICKERS.length;
  const pricesMap = { SMH: smhPrices };
  let done = 0, ok = 0, fail = 0;

  setStatus(`0 / ${total} 종목 다운로드 중...`);
  setProgress(0, total);

  // 배치 처리
  for (let i = 0; i < total; i += CONCURRENCY) {
    const batch = TICKERS.slice(i, i + CONCURRENCY);
    const results = await Promise.all(batch.map(async tk => {
      const prices = await fetchMonthly(tk);
      return [tk, prices];
    }));
    for (const [tk, prices] of results) {
      done++;
      if (prices) { pricesMap[tk] = prices; ok++; }
      else { fail++; }
    }
    setProgress(done, total);
    setStatus(`${done} / ${total} 종목 완료 (성공: ${ok} / 실패: ${fail})`);
    if (i + CONCURRENCY < total) await sleep(120); // rate limit
  }

  log(`다운로드 완료: 성공 ${ok} / 실패 ${fail} / 전체 ${total}`);

  // 3. 상관계수 계산
  setStatus('상관계수 계산 중...');
  const smhCorr = { SMH: 1.0 };
  let corrOk = 0, corrSkip = 0;

  for (const tk of TICKERS) {
    if (!(tk in pricesMap)) { corrSkip++; continue; }
    const [retA, retB] = pairwiseReturns(pricesMap[tk], smhPrices);
    if (retA.length < MIN_MONTHS) { corrSkip++; continue; }
    const r = pearson(retA, retB);
    if (isFinite(r)) { smhCorr[tk] = Math.round(r * 10000) / 10000; corrOk++; }
    else { corrSkip++; }
  }

  log(`상관계수 계산: 완료 ${corrOk} / 스킵 ${corrSkip}`);

  // 4. localStorage 저장
  localStorage.setItem(LS_KEY, JSON.stringify(smhCorr));
  localStorage.setItem(LS_META_KEY, JSON.stringify({
    date: new Date().toISOString().slice(0, 10),
    count: corrOk
  }));

  setStatus(`✅ 완료! ${corrOk}종목의 SMH 상관계수가 저장되었습니다.`);
  document.getElementById('btn-goto').style.display = 'block';
  document.getElementById('btn-clear').style.display = 'block';
  running = false;
}
</script>
</body>
</html>
