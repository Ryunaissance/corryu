<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ETF ìŠ¤í¬ë¦¬ë„ˆ â€” CORRYU</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
<script src="/i18n.js"></script>
<style>
:root { --bg:#0a0d14; --card:rgba(18,22,36,0.92); --border:rgba(255,255,255,0.07); --t1:#e2e8f0; --t2:#94a3b8; --t3:#64748b; }
*{box-sizing:border-box;margin:0;padding:0}
body{background:var(--bg);color:var(--t1);font-family:'Inter',sans-serif;min-height:100vh;-webkit-font-smoothing:antialiased}
.glass{background:var(--card);backdrop-filter:blur(16px);border:1px solid var(--border);border-radius:14px}
.grad-line{position:fixed;top:0;left:0;right:0;height:3px;z-index:200;background:linear-gradient(90deg,#3b82f6,#8b5cf6,#ec4899,#f59e0b)}
.tg{background:linear-gradient(135deg,#60a5fa,#a78bfa);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
nav{position:fixed;top:3px;left:0;right:0;z-index:100;background:rgba(10,13,20,0.9);backdrop-filter:blur(20px);border-bottom:1px solid var(--border);height:56px;display:flex;align-items:center}
.nav-i{max-width:1500px;margin:0 auto;padding:0 24px;width:100%;display:flex;align-items:center;gap:14px}
.nav-back{display:flex;align-items:center;gap:6px;color:var(--t3);font-size:.82rem;font-weight:600;text-decoration:none;transition:color .15s}
.nav-back:hover{color:#60a5fa}
.nav-link{font-size:.78rem;color:var(--t3);text-decoration:none;font-weight:600;display:flex;align-items:center;gap:4px;transition:color .15s}
.nav-link:hover{color:var(--t1)}
.wrap{max-width:1500px;margin:0 auto;padding:76px 20px 56px}
#lb{height:3px;background:linear-gradient(90deg,#3b82f6,#8b5cf6);position:fixed;top:59px;left:0;width:0;z-index:99;transition:width .4s}

/* â”€â”€ ctrl card â”€â”€ */
.ctrl{padding:18px 22px;margin-bottom:12px}
.page-title{font-size:1.4rem;font-weight:900;letter-spacing:-.03em}
.page-sub{font-size:.78rem;color:var(--t3);margin-top:2px}
.preset-row{display:flex;align-items:center;gap:6px;flex-wrap:wrap;margin:12px 0 10px}
.preset-btn{padding:5px 12px;border-radius:7px;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);color:var(--t2);font-size:.78rem;font-weight:700;cursor:pointer;font-family:inherit;transition:all .15s}
.preset-btn:hover,.preset-btn.on{background:rgba(59,130,246,0.15);border-color:rgba(59,130,246,0.4);color:#60a5fa}
.sec-label{font-size:.68rem;color:var(--t3);font-weight:700;margin-bottom:5px}
.sec-chips{display:flex;gap:5px;flex-wrap:wrap;margin-bottom:12px}
.sc{padding:3px 9px;border-radius:5px;background:rgba(255,255,255,0.035);border:1px solid rgba(255,255,255,0.07);color:var(--t3);font-size:.7rem;font-weight:700;cursor:pointer;transition:all .15s}
.sc:hover{color:var(--t2)}
.sc.on{background:rgba(59,130,246,0.15);border-color:rgba(59,130,246,0.4);color:#60a5fa}
.fg{display:grid;grid-template-columns:repeat(auto-fit,minmax(175px,1fr));gap:10px;margin-top:10px}
.fi label{display:block;font-size:.67rem;color:var(--t3);font-weight:700;text-transform:uppercase;letter-spacing:.04em;margin-bottom:5px}
.range-row{display:flex;align-items:center;gap:5px}
.ni{background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:7px;color:var(--t1);font-size:.82rem;font-family:inherit;padding:6px 9px;width:72px;outline:none;transition:border .15s}
.ni:focus{border-color:rgba(59,130,246,0.4)}
.ni::placeholder{color:var(--t3)}
.unit{font-size:.72rem;color:var(--t3)}
.sel{background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:7px;color:var(--t1);font-size:.82rem;font-family:inherit;padding:6px 9px;outline:none;cursor:pointer;width:100%}
.tgl-label{display:flex;align-items:center;gap:6px;font-size:.75rem;color:var(--t2);cursor:pointer;font-weight:600}
.tgl-label input{accent-color:#3b82f6;width:14px;height:14px}
.badge-row{display:flex;align-items:center;gap:10px;margin-top:12px;flex-wrap:wrap}
.res-badge{padding:4px 12px;border-radius:20px;background:rgba(59,130,246,0.12);border:1px solid rgba(59,130,246,0.25);color:#60a5fa;font-size:.78rem;font-weight:800}

/* â”€â”€ table â”€â”€ */
.tcard{padding:0;overflow:hidden}
.t-scroll{overflow-x:auto}
table.rt{width:100%;border-collapse:collapse}
table.rt thead th{
  padding:10px 12px;font-size:.67rem;font-weight:700;letter-spacing:.06em;text-transform:uppercase;
  color:var(--t3);border-bottom:1px solid var(--border);text-align:left;white-space:nowrap;
  cursor:pointer;user-select:none;transition:color .15s;position:sticky;top:0;
  background:rgba(13,17,28,0.95);
}
table.rt thead th:hover{color:var(--t1)}
table.rt thead th.sort-on{color:#60a5fa}
table.rt tbody tr{transition:background .1s;cursor:pointer;border-bottom:1px solid rgba(255,255,255,0.025)}
table.rt tbody tr:hover{background:rgba(255,255,255,0.03)}
table.rt tbody tr:last-child{border-bottom:none}
table.rt tbody td{padding:9px 12px;font-size:.82rem;font-weight:700;white-space:nowrap;font-variant-numeric:tabular-nums}
.t-ticker{color:#60a5fa;text-decoration:none;font-weight:800;font-size:.86rem}
.t-ticker:hover{text-decoration:underline}
.t-name{color:var(--t2);font-weight:500;font-size:.78rem;max-width:200px;overflow:hidden;text-overflow:ellipsis}
.stag{padding:2px 7px;border-radius:4px;font-size:.65rem;font-weight:800;background:rgba(255,255,255,0.05);color:var(--t3);white-space:nowrap}
.pos{color:#4ade80}.neg{color:#f87171}.amb{color:#f59e0b}.mu{color:var(--t3)}
.z-hi{color:#f87171}.z-lo{color:#60a5fa}.z-mid{color:var(--t2)}
.rsi-hi{color:#f87171}.rsi-lo{color:#4ade80}
.act-btn{padding:3px 9px;border-radius:5px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.08);color:var(--t3);font-size:.7rem;font-weight:700;text-decoration:none;cursor:pointer;font-family:inherit;transition:all .15s;display:inline-block}
.act-btn:hover{background:rgba(59,130,246,0.12);border-color:rgba(59,130,246,0.3);color:#60a5fa}
.act-btn.corr:hover{background:rgba(167,139,250,0.12);border-color:rgba(167,139,250,0.3);color:#a78bfa}
.acts{display:flex;gap:5px;opacity:0;transition:opacity .15s}
tr:hover .acts{opacity:1}
.empty-row td{text-align:center;padding:48px;color:var(--t3);font-size:.88rem}

/* sort arrows */
th .arr{font-size:.6rem;opacity:.4;margin-left:3px}
th.sort-on .arr{opacity:1}
</style>
</head>
<body>
<div class="grad-line"></div>
<div id="lb"></div>

<nav>
  <div class="nav-i">
    <a href="/index" class="nav-back">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M19 12H5M12 5l-7 7 7 7"/></svg>ëŒ€ì‹œë³´ë“œ
    </a>
    <span style="color:#1e293b">/</span>
    <a href="/landing" style="font-size:.95rem;font-weight:900;text-decoration:none"><span class="tg">CORRYU</span></a>
    <span style="font-size:.82rem;color:var(--t3)">/ ìŠ¤í¬ë¦¬ë„ˆ</span>
    <div style="margin-left:auto;display:flex;align-items:center;gap:14px">
      <a href="/correlation" class="nav-link">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="8" cy="8" r="2"/><circle cx="16" cy="8" r="2"/><circle cx="12" cy="16" r="2"/><line x1="10" y1="8" x2="14" y2="8"/><line x1="9" y1="10" x2="11" y2="14"/><line x1="15" y1="10" x2="13" y2="14"/></svg>ìƒê´€ê´€ê³„
      </a>
      <a href="/backtest" class="nav-link">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>ë°±í…ŒìŠ¤íŠ¸
      </a>
      <a href="/compare" class="nav-link">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>ë¹„êµ
      </a>
    </div>
  </div>
</nav>

<div class="wrap">

  <!-- ì»¨íŠ¸ë¡¤ ì¹´ë“œ -->
  <div class="glass ctrl">
    <div style="display:flex;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;gap:8px;margin-bottom:4px">
      <div>
        <div class="page-title">ETF <span class="tg">ìŠ¤í¬ë¦¬ë„ˆ</span></div>
        <div class="page-sub">ì¡°ê±´ì„ ì¡°í•©í•´ ì¢…ëª©ì„ íƒìƒ‰í•˜ì„¸ìš” â€” ì •ë ¬ í—¤ë” í´ë¦­ìœ¼ë¡œ ì¬ì •ë ¬</div>
      </div>
    </div>

    <!-- í”„ë¦¬ì…‹ -->
    <div class="preset-row">
      <span style="font-size:.68rem;color:var(--t3);font-weight:700">ë¹ ë¥¸ ì¡°ê±´</span>
      <button class="preset-btn on" id="pr-all"        onclick="applyPreset('all')">ì „ì²´</button>
      <button class="preset-btn" id="pr-oversold"     onclick="applyPreset('oversold')">ğŸ“‰ ê³¼ë§¤ë„ íƒìƒ‰</button>
      <button class="preset-btn" id="pr-momentum"     onclick="applyPreset('momentum')">ğŸš€ ëª¨ë©˜í…€ ê°•í•œ ì¢…ëª©</button>
      <button class="preset-btn" id="pr-lowvol"       onclick="applyPreset('lowvol')">ğŸ›¡ï¸ ì €ë³€ë™ ì•ˆì •í˜•</button>
      <button class="preset-btn" id="pr-highreturn"   onclick="applyPreset('highreturn')">ğŸ’ ê³ ìˆ˜ìµ íƒìƒ‰</button>
    </div>

    <!-- ì„¹í„° ì¹© -->
    <div class="sec-label">ì„¹í„° <span style="color:#1e293b;font-weight:400">(ë³µìˆ˜ ì„ íƒ ê°€ëŠ¥ Â· ë¯¸ì„ íƒ ì‹œ ì „ì²´)</span></div>
    <div class="sec-chips" id="sec-chips">
      <!-- JSë¡œ ìƒì„± -->
    </div>

    <!-- ìˆ«ì í•„í„° ê·¸ë¦¬ë“œ -->
    <div class="fg">
      <div class="fi">
        <label>CAGR ë²”ìœ„</label>
        <div class="range-row">
          <input class="ni" type="number" id="f-cagr-min" placeholder="ìµœì†Œ">
          <span class="unit">~</span>
          <input class="ni" type="number" id="f-cagr-max" placeholder="ìµœëŒ€">
          <span class="unit">%</span>
        </div>
      </div>
      <div class="fi">
        <label>ë³€ë™ì„± (Vol)</label>
        <div class="range-row">
          <input class="ni" type="number" id="f-vol-min" placeholder="ìµœì†Œ">
          <span class="unit">~</span>
          <input class="ni" type="number" id="f-vol-max" placeholder="ìµœëŒ€">
          <span class="unit">%</span>
        </div>
      </div>
      <div class="fi">
        <label>Z-Score ë²”ìœ„</label>
        <div class="range-row">
          <input class="ni" type="number" id="f-z-min" step="0.1" placeholder="ìµœì†Œ">
          <span class="unit">~</span>
          <input class="ni" type="number" id="f-z-max" step="0.1" placeholder="ìµœëŒ€">
        </div>
      </div>
      <div class="fi">
        <label>Sortino ìµœì†Œ</label>
        <div class="range-row">
          <input class="ni" type="number" id="f-sortino-min" step="0.1" placeholder="ì˜ˆ: 1.0">
          <span class="unit">ì´ìƒ</span>
        </div>
      </div>
      <div class="fi">
        <label>AUM ìµœì†Œ</label>
        <select class="sel" id="f-aum" onchange="doFilter()">
          <option value="0">ì „ì²´</option>
          <option value="100000000">$1ì–µ+</option>
          <option value="1000000000">$10ì–µ+</option>
          <option value="10000000000">$100ì–µ+</option>
          <option value="100000000000">$1ì¡°+</option>
        </select>
      </div>
      <div class="fi">
        <label>ì˜µì…˜</label>
        <div style="display:flex;flex-direction:column;gap:6px">
          <label class="tgl-label"><input type="checkbox" id="f-legacy" checked onchange="doFilter()"> ë ˆê±°ì‹œ ì œì™¸</label>
          <label class="tgl-label"><input type="checkbox" id="f-short" onchange="doFilter()"> ì§§ì€ ì—°í˜ ì œì™¸</label>
        </div>
      </div>
    </div>

    <div class="badge-row">
      <div class="res-badge">ê²°ê³¼ <span id="res-count">â€”</span>ê°œ ETF</div>
      <span style="font-size:.7rem;color:#1e293b">í´ë¦­í•˜ì—¬ ETF ìƒì„¸í˜ì´ì§€ë¡œ ì´ë™</span>
    </div>
  </div>

  <!-- ê²°ê³¼ í…Œì´ë¸” -->
  <div class="glass tcard">
    <div class="t-scroll">
      <table class="rt" id="rt">
        <thead>
          <tr>
            <th onclick="sortBy('ticker')"  data-col="ticker">í‹°ì»¤<span class="arr">â†•</span></th>
            <th data-col="_name" style="cursor:default">ì¢…ëª©ëª…</th>
            <th onclick="sortBy('_sid')"    data-col="_sid">ì„¹í„°<span class="arr">â†•</span></th>
            <th onclick="sortBy('cagr')"    data-col="cagr">CAGR<span class="arr">â†•</span></th>
            <th onclick="sortBy('vol')"     data-col="vol">ë³€ë™ì„±<span class="arr">â†•</span></th>
            <th onclick="sortBy('sortino')" data-col="sortino">Sortino<span class="arr">â†•</span></th>
            <th onclick="sortBy('z_score')" data-col="z_score">Z-Score<span class="arr">â†•</span></th>
            <th onclick="sortBy('rsi')"     data-col="rsi">RSI<span class="arr">â†•</span></th>
            <th onclick="sortBy('mdd_52w')" data-col="mdd_52w">MDD<span class="arr">â†•</span></th>
            <th onclick="sortBy('aum')"     data-col="aum">AUM<span class="arr">â†•</span></th>
            <th style="cursor:default"></th>
          </tr>
        </thead>
        <tbody id="rt-body">
          <tr class="empty-row"><td colspan="11">ë°ì´í„° ë¡œë“œ ì¤‘â€¦</td></tr>
        </tbody>
      </table>
    </div>
  </div>

</div><!-- /wrap -->

<script>
// â”€â”€ ìƒìˆ˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SECTOR_SHORT = {
  S01:'ë¯¸êµ­ëŒ€í˜•',S02:'ê¸°ìˆ ',S03:'í—¬ìŠ¤ì¼€ì–´',S04:'ê¸ˆìœµ',S05:'ì†Œë¹„ì¬',
  S06:'í•„ìˆ˜ì†Œë¹„',S07:'ì‚°ì—…ì¬',S08:'ìœ í‹¸ë¦¬í‹°',S09:'ì»¤ë®¤ë‹ˆì¼€ì´ì…˜',S10:'ì†Œì¬',
  S11:'ì„ ì§„êµ­',S12:'ì‹ í¥êµ­',S13:'ì†Œí˜•/ì¤‘í˜•',S14:'IGì±„ê¶Œ',S15:'ë‹¨ê¸°ì±„',
  S16:'HYì±„ê¶Œ',S17:'TIPS',S18:'ê¸ˆ/ì›ìì¬',S19:'ì—ë„ˆì§€',S20:'ë¦¬ì¸ ',
  S21:'ì•”í˜¸í™”í',S22:'ì¸ë²„ìŠ¤',S23:'ê¸°íƒ€',S24:'ê¸°íƒ€',
};

// í”„ë¦¬ì…‹ ì •ì˜
const PRESETS = {
  all:       { cagrMin:'', cagrMax:'', volMin:'', volMax:'', zMin:'', zMax:'', sortinoMin:'', aum:'0', legacy:true, short:false, sectors:[] },
  oversold:  { cagrMin:'', cagrMax:'', volMin:'', volMax:'', zMin:'-4', zMax:'-1.5', sortinoMin:'', aum:'0', legacy:true, short:true,  sectors:[] },
  momentum:  { cagrMin:'10', cagrMax:'', volMin:'', volMax:'', zMin:'0.5', zMax:'4', sortinoMin:'1.0', aum:'100000000', legacy:true, short:true,  sectors:[] },
  lowvol:    { cagrMin:'0',  cagrMax:'', volMin:'', volMax:'18', zMin:'', zMax:'', sortinoMin:'0.8', aum:'0', legacy:true, short:false, sectors:[] },
  highreturn:{ cagrMin:'20', cagrMax:'', volMin:'', volMax:'', zMin:'', zMax:'', sortinoMin:'1.5', aum:'100000000', legacy:true, short:true,  sectors:[] },
};

// â”€â”€ ìƒíƒœ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let allEtfs = [];
let sectorMeta = {};
let selSectors = new Set();
let sortCol = 'sortino';
let sortDir = -1; // -1=desc +1=asc

// â”€â”€ í¬ë§· í—¬í¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const fPct = (v,d=1) => v==null?'â€”':(v>0?'+':'')+Number(v).toFixed(d)+'%';
const fNum = (v,d=2) => v==null?'â€”':Number(v).toFixed(d);
const fAUM = v => {
  if (!v) return 'â€”';
  const m = v/1e6;
  return m>=1000 ? '$'+(m/1000).toFixed(1)+'B' : '$'+Math.round(m)+'M';
};

// â”€â”€ ì„¹í„° ì¹© ìƒì„± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildSectorChips() {
  const sids = Object.keys(sectorMeta).sort();
  const container = document.getElementById('sec-chips');
  container.innerHTML = sids.map(sid => {
    const name = SECTOR_SHORT[sid] || (sectorMeta[sid]?.name || sid);
    return `<button class="sc" data-sid="${sid}" onclick="toggleSec('${sid}')">${name}</button>`;
  }).join('');
}

function toggleSec(sid) {
  const btn = document.querySelector(`.sc[data-sid="${sid}"]`);
  if (selSectors.has(sid)) {
    selSectors.delete(sid);
    btn.classList.remove('on');
  } else {
    selSectors.add(sid);
    btn.classList.add('on');
  }
  doFilter();
}

// â”€â”€ í”„ë¦¬ì…‹ ì ìš© â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function applyPreset(key) {
  document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('on'));
  document.getElementById('pr-' + key)?.classList.add('on');
  const p = PRESETS[key];
  document.getElementById('f-cagr-min').value   = p.cagrMin;
  document.getElementById('f-cagr-max').value   = p.cagrMax;
  document.getElementById('f-vol-min').value     = p.volMin;
  document.getElementById('f-vol-max').value     = p.volMax;
  document.getElementById('f-z-min').value       = p.zMin;
  document.getElementById('f-z-max').value       = p.zMax;
  document.getElementById('f-sortino-min').value = p.sortinoMin;
  document.getElementById('f-aum').value         = p.aum;
  document.getElementById('f-legacy').checked    = p.legacy;
  document.getElementById('f-short').checked     = p.short;
  // ì„¹í„° ì´ˆê¸°í™”
  selSectors.clear();
  document.querySelectorAll('.sc').forEach(b => b.classList.remove('on'));
  doFilter();
}

// â”€â”€ í•„í„° ë¡œì§ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getNum(id) {
  const v = document.getElementById(id).value.trim();
  return v === '' ? null : parseFloat(v);
}

function doFilter() {
  const cagrMin    = getNum('f-cagr-min');
  const cagrMax    = getNum('f-cagr-max');
  const volMin     = getNum('f-vol-min');
  const volMax     = getNum('f-vol-max');
  const zMin       = getNum('f-z-min');
  const zMax       = getNum('f-z-max');
  const sortinoMin = getNum('f-sortino-min');
  const aumMin     = parseFloat(document.getElementById('f-aum').value) || 0;
  const hideLegacy = document.getElementById('f-legacy').checked;
  const hideShort  = document.getElementById('f-short').checked;

  const filtered = allEtfs.filter(e => {
    if (hideLegacy && e.is_legacy)  return false;
    if (hideShort  && e.short_history) return false;
    if (selSectors.size > 0 && !selSectors.has(e._sid)) return false;
    if (cagrMin    != null && (e.cagr ?? -999) < cagrMin)    return false;
    if (cagrMax    != null && (e.cagr ?? 999)  > cagrMax)    return false;
    if (volMin     != null && (e.vol  ?? -999) < volMin)     return false;
    if (volMax     != null && (e.vol  ?? 999)  > volMax)     return false;
    if (!e.short_history) {
      if (zMin != null && (e.z_score ?? -999) < zMin) return false;
      if (zMax != null && (e.z_score ??  999) > zMax) return false;
    }
    if (sortinoMin != null && (e.sortino ?? -999) < sortinoMin) return false;
    if (aumMin > 0 && (e.aum ?? 0) < aumMin) return false;
    return true;
  });

  // ì •ë ¬
  filtered.sort((a, b) => {
    let av = a[sortCol], bv = b[sortCol];
    if (av == null) av = sortDir === -1 ? -Infinity : Infinity;
    if (bv == null) bv = sortDir === -1 ? -Infinity : Infinity;
    if (typeof av === 'string') return sortDir * av.localeCompare(bv);
    return sortDir * (av - bv);
  });

  renderTable(filtered);
}

// â”€â”€ ì •ë ¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function sortBy(col) {
  if (sortCol === col) sortDir *= -1;
  else { sortCol = col; sortDir = -1; }
  document.querySelectorAll('th[data-col]').forEach(th => {
    th.classList.toggle('sort-on', th.dataset.col === col);
    const arr = th.querySelector('.arr');
    if (arr) arr.textContent = th.dataset.col === col ? (sortDir === -1 ? 'â†“' : 'â†‘') : 'â†•';
  });
  doFilter();
}

// â”€â”€ í…Œì´ë¸” ë Œë” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderTable(data) {
  document.getElementById('res-count').textContent = data.length;
  const body = document.getElementById('rt-body');
  if (data.length === 0) {
    body.innerHTML = '<tr class="empty-row"><td colspan="11">ì¡°ê±´ì— ë§ëŠ” ETFê°€ ì—†ìŠµë‹ˆë‹¤. í•„í„°ë¥¼ ì¡°ì •í•´ë³´ì„¸ìš”.</td></tr>';
    return;
  }
  // ìµœëŒ€ 300ê°œë§Œ ë Œë”ë§
  const rows = data.slice(0, 300).map(e => {
    const sn  = SECTOR_SHORT[e._sid] || e._sid || 'â€”';
    const cagrC  = e.cagr  == null ? 'mu' : e.cagr >= 0 ? 'pos' : 'neg';
    const sortC  = e.sortino == null ? 'mu' : e.sortino >= 1.2 ? 'pos' : e.sortino < 0 ? 'neg' : 'mu';
    const zC     = e.short_history || e.z_score == null ? 'mu'
                 : e.z_score >= 2 ? 'z-hi' : e.z_score <= -1.5 ? 'z-lo' : 'z-mid';
    const rsiC   = e.rsi == null ? 'mu' : e.rsi >= 70 ? 'rsi-hi' : e.rsi <= 30 ? 'rsi-lo' : 'mu';
    const mddC   = e.mdd_52w != null && e.mdd_52w <= -20 ? 'neg' : 'mu';
    const isShort = e.short_history;
    return `<tr onclick="location.href='/etf-detail?ticker=${e.ticker}'">
      <td><a class="t-ticker" href="/etf-detail?ticker=${e.ticker}" onclick="event.stopPropagation()">${e.ticker}</a></td>
      <td class="t-name" title="${e.name || ''}">${e.name || 'â€”'}</td>
      <td><span class="stag">${sn}</span></td>
      <td class="${cagrC}">${fPct(e.cagr)}</td>
      <td class="amb">${e.vol != null ? e.vol.toFixed(1)+'%' : 'â€”'}</td>
      <td class="${sortC}">${fNum(e.sortino)}</td>
      <td class="${zC}">${isShort || e.z_score==null ? 'â€”' : (e.z_score>0?'+':'')+e.z_score.toFixed(2)}</td>
      <td class="${rsiC}">${e.rsi != null ? Math.round(e.rsi) : 'â€”'}</td>
      <td class="${mddC}">${isShort || e.mdd_52w==null ? 'â€”' : e.mdd_52w.toFixed(1)+'%'}</td>
      <td class="mu" style="font-size:.76rem">${fAUM(e.aum)}</td>
      <td>
        <div class="acts">
          <a class="act-btn" href="/compare?a=${e.ticker}" onclick="event.stopPropagation()" title="ETF ë¹„êµ">ë¹„êµ</a>
          <a class="act-btn corr" href="/correlation?tickers=${e.ticker}" onclick="event.stopPropagation()" title="ìƒê´€ê´€ê³„ ë¶„ì„">ìƒê´€ê´€ê³„</a>
        </div>
      </td>
    </tr>`;
  });
  body.innerHTML = rows.join('');
}

// â”€â”€ ì´ë²¤íŠ¸ ë°”ì¸ë”© â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
['f-cagr-min','f-cagr-max','f-vol-min','f-vol-max','f-z-min','f-z-max','f-sortino-min'].forEach(id => {
  document.getElementById(id).addEventListener('input', () => {
    // í”„ë¦¬ì…‹ í•˜ì´ë¼ì´íŠ¸ í•´ì œ
    document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('on'));
    doFilter();
  });
});

// ì´ˆê¸° ì •ë ¬ í‘œì‹œ
document.querySelector(`th[data-col="${sortCol}"]`)?.classList.add('sort-on');
document.querySelector(`th[data-col="${sortCol}"] .arr`).textContent = 'â†“';

// â”€â”€ ë°ì´í„° ë¡œë“œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const lb = document.getElementById('lb');
lb.style.width = '40%';
fetch('/etf_data.json').then(r => r.json()).then(data => {
  sectorMeta = data.sectorMeta || {};
  for (const [sid, etfs] of Object.entries(data)) {
    if (sid === 'sectorMeta') continue;
    if (!Array.isArray(etfs)) continue;
    for (const etf of etfs) allEtfs.push({ ...etf, _sid: sid });
  }
  lb.style.width = '100%';
  setTimeout(() => { lb.style.width = '0'; lb.style.transition = 'none'; }, 400);
  buildSectorChips();
  // URL íŒŒë¼ë¯¸í„°ë¡œ í”„ë¦¬ì…‹ ë¡œë“œ
  const preset = new URLSearchParams(location.search).get('preset');
  if (preset && PRESETS[preset]) applyPreset(preset);
  else doFilter();
  I18n.init();
}).catch(() => {
  document.getElementById('rt-body').innerHTML = '<tr class="empty-row"><td colspan="11">ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨. ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”.</td></tr>';
});
</script>
</body>
</html>
