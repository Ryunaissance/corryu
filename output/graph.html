<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ETF ìƒê´€ê´€ê³„ ê·¸ë˜í”„</title>
  <script src="https://unpkg.com/force-graph@1.43.5/dist/force-graph.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      background: #0d1117;
      color: #e6edf3;
      font-family: 'SF Mono', 'Consolas', 'Menlo', monospace;
      overflow: hidden;
    }
    #graph-container { width: 100vw; height: 100vh; }

    /* â”€â”€ ì»¨íŠ¸ë¡¤ íŒ¨ë„ â”€â”€ */
    #controls {
      position: fixed; top: 14px; left: 14px; z-index: 100;
      background: rgba(13,17,23,0.90);
      border: 1px solid #30363d;
      border-radius: 10px;
      padding: 14px 16px;
      min-width: 240px;
      backdrop-filter: blur(10px);
    }
    #controls h1 {
      font-size: 13px; font-weight: 700;
      color: #60a5fa; margin-bottom: 12px; letter-spacing: 0.3px;
    }
    .ctrl-row { margin-bottom: 10px; }
    .ctrl-check {
      display: flex; align-items: center; gap: 7px;
      font-size: 11px; color: #8b949e; cursor: pointer; user-select: none;
    }
    .ctrl-check input[type=checkbox] {
      accent-color: #60a5fa; cursor: pointer; width: 13px; height: 13px;
    }
    .ctrl-check span { color: #e6edf3; }
    .ctrl-label {
      font-size: 11px; color: #8b949e;
      display: flex; justify-content: space-between; margin-bottom: 4px;
    }
    .ctrl-label span { color: #e6edf3; font-weight: 600; }
    input[type=range] { width: 100%; accent-color: #60a5fa; cursor: pointer; }
    #search {
      width: 100%;
      background: #161b22; border: 1px solid #30363d;
      color: #e6edf3; font-family: inherit; font-size: 12px;
      padding: 5px 8px; border-radius: 6px; outline: none;
      transition: border-color 0.2s;
    }
    #search:focus { border-color: #60a5fa; }
    #search::placeholder { color: #484f58; }
    #stats {
      font-size: 11px; color: #8b949e;
      margin-top: 10px; border-top: 1px solid #21262d; padding-top: 8px;
      line-height: 1.7;
    }
    #stats b { color: #e6edf3; }
    #progress-bar {
      width: 100%; height: 2px; background: #21262d;
      border-radius: 2px; margin-top: 6px; overflow: hidden;
    }
    #progress-fill {
      height: 100%; background: #60a5fa; width: 0%;
      transition: width 0.3s ease;
    }
    .sim-running { color: #fbbf24 !important; }

    /* â”€â”€ ë ˆì „ë“œ â”€â”€ */
    #legend {
      position: fixed; top: 14px; right: 14px; z-index: 100;
      background: rgba(13,17,23,0.90);
      border: 1px solid #30363d;
      border-radius: 10px; padding: 12px 14px;
      max-height: calc(100vh - 28px); overflow-y: auto;
      backdrop-filter: blur(10px); min-width: 185px;
    }
    #legend::-webkit-scrollbar { width: 4px; }
    #legend::-webkit-scrollbar-track { background: transparent; }
    #legend::-webkit-scrollbar-thumb { background: #30363d; border-radius: 4px; }
    #legend h2 {
      font-size: 10px; color: #8b949e; margin-bottom: 8px;
      letter-spacing: 0.8px; text-transform: uppercase;
    }
    .legend-ac {
      font-size: 10px; color: #484f58; margin: 7px 0 3px;
      text-transform: uppercase; letter-spacing: 0.5px;
    }
    .legend-item {
      display: flex; align-items: center; gap: 7px;
      padding: 3px 4px; border-radius: 4px; cursor: pointer;
      transition: background 0.12s, opacity 0.12s;
    }
    .legend-item:hover { background: #161b22; }
    .legend-item.active { background: rgba(96,165,250,0.12); outline: 1px solid rgba(96,165,250,0.35); }
    .legend-item.dimmed { opacity: 0.35; }
    .legend-dot { width: 9px; height: 9px; border-radius: 50%; flex-shrink: 0; }
    .legend-text { font-size: 11px; color: #c9d1d9; }

    /* â”€â”€ íˆ´íŒ â”€â”€ */
    #tooltip {
      position: fixed; display: none; z-index: 200;
      background: rgba(13,17,23,0.96);
      border: 1px solid #30363d;
      border-radius: 8px; padding: 10px 13px;
      font-size: 12px; pointer-events: none; max-width: 270px;
    }
    .tt-ticker { font-weight: 700; font-size: 14px; }
    .tt-name   { color: #8b949e; margin-top: 3px; line-height: 1.4; font-size: 11px; }
    .tt-divider{ border-top: 1px solid #21262d; margin: 7px 0 5px; }
    .tt-row    { display: flex; justify-content: space-between; gap: 16px; margin-bottom: 2px; }
    .tt-key    { color: #8b949e; font-size: 11px; }
    .tt-val    { color: #e6edf3; font-size: 11px; font-weight: 600; }
    .tt-hint   { font-size: 10px; color: #484f58; margin-top: 6px; }

    /* â”€â”€ í•˜ë‹¨ íŒíŠ¸ â”€â”€ */
    #hint {
      position: fixed; bottom: 14px; left: 50%; transform: translateX(-50%);
      z-index: 100; font-size: 10px; color: #484f58; pointer-events: none;
      white-space: nowrap;
    }

    /* â”€â”€ í™ˆ ë§í¬ â”€â”€ */
    #home-link {
      position: fixed; bottom: 14px; left: 14px; z-index: 100;
      font-size: 11px; color: #8b949e; text-decoration: none;
      background: rgba(13,17,23,0.88); border: 1px solid #30363d;
      border-radius: 6px; padding: 5px 10px; transition: color 0.15s;
    }
    #home-link:hover { color: #60a5fa; border-color: #60a5fa; }

    /* â”€â”€ ì—ëŸ¬ í™”ë©´ â”€â”€ */
    #error-screen {
      display: none; position: fixed; inset: 0;
      background: #0d1117; z-index: 300;
      align-items: center; justify-content: center;
      flex-direction: column; text-align: center; gap: 14px;
    }
    #error-screen.show { display: flex; }
    #error-screen h2 { color: #ef4444; font-size: 18px; }
    #error-screen code {
      background: #161b22; border: 1px solid #30363d;
      border-radius: 8px; padding: 10px 20px;
      font-size: 13px; color: #60a5fa; font-family: inherit;
    }
    #error-screen p { color: #8b949e; font-size: 13px; line-height: 1.6; }
  </style>
</head>
<body>

<!-- ì»¨íŠ¸ë¡¤ íŒ¨ë„ -->
<div id="controls">
  <h1>ETF ìƒê´€ê´€ê³„ ê·¸ë˜í”„</h1>

  <div class="ctrl-row">
    <div class="ctrl-label">
      ì„ê³„ê°’ (r â‰¥) <span id="r-val">0.95</span>
    </div>
    <input type="range" id="r-slider" min="85" max="99" value="95" step="1">
    <div style="display:flex;justify-content:space-between;font-size:10px;color:#484f58;margin-top:2px">
      <span id="r-min-label">0.85</span><span>0.99</span>
    </div>
  </div>

  <div class="ctrl-row">
    <input type="text" id="search" placeholder="í‹°ì»¤ ê²€ìƒ‰ (ì˜ˆ: SPY, QQQ, GLD)">
  </div>

  <div class="ctrl-row">
    <label class="ctrl-check">
      <input type="checkbox" id="hide-legacy" checked>
      ë ˆê±°ì‹œ ìˆ¨ê¸°ê¸° <span id="legacy-count"></span>
    </label>
  </div>

  <div class="ctrl-row">
    <label class="ctrl-check">
      <input type="checkbox" id="super-sector-toggle">
      ğŸŒ ì£¼ì‹ ì‹œì¥ í†µí•© ìƒ‰ìƒ
    </label>
  </div>

  <div id="stats">ë°ì´í„° ë¡œë”© ì¤‘...</div>
  <div id="progress-bar"><div id="progress-fill"></div></div>
</div>

<!-- ë ˆì „ë“œ -->
<div id="legend">
  <h2>ì„¹í„°</h2>
  <div id="legend-items"></div>
</div>

<!-- ê·¸ë˜í”„ -->
<div id="graph-container"></div>

<!-- íˆ´íŒ -->
<div id="tooltip">
  <div class="tt-ticker" id="tt-ticker"></div>
  <div class="tt-name"   id="tt-name"></div>
  <div class="tt-divider"></div>
  <div id="tt-meta"></div>
  <div class="tt-hint">í´ë¦­ â†’ í•´ë‹¹ ë…¸ë“œ í¬ì»¤ìŠ¤ | ë°°ê²½ í´ë¦­ â†’ ì „ì²´ ë³´ê¸°</div>
</div>

<!-- í•˜ë‹¨ íŒíŠ¸ -->
<div id="hint">r = 1 ì´ë©´ ê°€ê¹ê²Œ Â· r = âˆ’1 ì´ë©´ ë©€ê²Œ &nbsp;|&nbsp; ìŠ¤í¬ë¡¤ë¡œ ì¤Œ Â· ë“œë˜ê·¸ë¡œ ì´ë™</div>

<!-- í™ˆ -->
<a href="/" id="home-link">â† ëŒ€ì‹œë³´ë“œ</a>

<!-- ì—ëŸ¬ -->
<div id="error-screen">
  <h2>graph_data.json ì—†ìŒ</h2>
  <p>ê·¸ë˜í”„ ë°ì´í„°ê°€ ì•„ì§ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.<br>ë¡œì»¬ì—ì„œ ì•„ë˜ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•œ í›„ ë°°í¬í•˜ì„¸ìš”.</p>
  <code>python build_graph.py</code>
  <p style="font-size:11px;color:#484f58">
    (ì‚¬ì „ ì¡°ê±´: python build_monthly_corr.py ë¡œ<br>correlation_matrix_monthly.csv ìƒì„± í•„ìš”)
  </p>
</div>

<script>
// â”€â”€ ìƒìˆ˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DEFAULT_R    = 0.95;
const LINK_DIST_K  = 800;   // link distance = (1 - r) * K  â†’  r=1: 0px, r=0: 800px
const LINK_STRENGTH_K = 0.8; // link strength = (r - 0.8) * K  â†’  r=0.95: 0.12

// â”€â”€ ì „ì—­ ìƒíƒœ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let allNodes    = [];
let allLinks    = [];
let sectorMeta  = {};
let Graph;
let storeMinR   = 0.85;
let currentR    = DEFAULT_R;

let hoverNode        = null;
let highlightNodeIds = new Set();
let searchTicker     = '';
let hideLegacy       = true;
let focusSector      = null;   // ë ˆì „ë“œ í´ë¦­ìœ¼ë¡œ ì„ íƒëœ ì„¹í„° ID (or 'SS_<id>')
let superSectorMode  = false;  // ìŠˆí¼ì„¹í„° í†µí•© ìƒ‰ìƒ í† ê¸€
let superSectorMeta  = {};     // graph_data.json ì—ì„œ ë¡œë“œ

// â”€â”€ ìƒ‰ìƒ / í¬ê¸° í•¨ìˆ˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function sectorColor(sid) {
  return (sectorMeta[sid] || {}).color || '#888888';
}

function effectiveColor(node) {
  // ìŠˆí¼ì„¹í„° ëª¨ë“œì¼ ë•Œ í•´ë‹¹ ì„¹í„°ëŠ” ìŠˆí¼ì„¹í„° ìƒ‰ìœ¼ë¡œ í†µì¼
  if (superSectorMode) {
    const ss = (sectorMeta[node.s] || {}).ss;
    if (ss && superSectorMeta[ss]) return superSectorMeta[ss].color;
  }
  return sectorColor(node.s);
}

function getNodeColor(node) {
  const base = effectiveColor(node);
  if (searchTicker && node.id === searchTicker) return '#ffffff';
  if (hoverNode) {
    if (node === hoverNode)              return '#ffffff';
    if (highlightNodeIds.has(node.id))  return base;
    return base + '22';  // íë¦¬ê²Œ
  }
  if (focusSector) {
    // 'SS_<id>' í˜•íƒœì´ë©´ ìŠˆí¼ì„¹í„° ì†Œì† ì „ì²´ í•˜ì´ë¼ì´íŠ¸
    if (focusSector.startsWith('SS_')) {
      const ssId = focusSector.slice(3);
      const nodeSS = (sectorMeta[node.s] || {}).ss;
      return nodeSS === ssId ? base : base + '18';
    }
    return node.s === focusSector ? base : base + '18';
  }
  return base;
}

function getNodeVal(node) {
  // logÂ² ìŠ¤ì¼€ì¼: 10ë°° AUMë§ˆë‹¤ radius +4px ($100Mâ‰ˆ8, $1Bâ‰ˆ12, $10Bâ‰ˆ16, $100Bâ‰ˆ20)
  return Math.max(1, Math.pow(Math.log10(node.a * 1000 + 1), 2));
}

function getLinkColor(link) {
  if (hoverNode) {
    const sid = typeof link.source === 'object' ? link.source.id : link.source;
    const tid = typeof link.target === 'object' ? link.target.id : link.target;
    const active = sid === hoverNode.id || tid === hoverNode.id;
    if (!active) return 'rgba(255,255,255,0.02)';
    // ë†’ì€ r â†’ ë”°ëœ»í•œ ìƒ‰, ë‚®ì€ r â†’ ì°¨ê°€ìš´ ìƒ‰
    const t = Math.max(0, Math.min(1, (link.r - 0.8) / 0.2));
    return `rgba(${Math.round(255*t)},${Math.round(120+80*t)},${Math.round(255*(1-t))},0.85)`;
  }
  const t = Math.max(0, (link.r - storeMinR) / (1 - storeMinR));
  if (focusSector) {
    const sn = typeof link.source === 'object' ? link.source : (Graph.graphData().nodes||[]).find(n=>n.id===link.source);
    const tn = typeof link.target === 'object' ? link.target : (Graph.graphData().nodes||[]).find(n=>n.id===link.target);
    if ((sn && sn.s === focusSector) || (tn && tn.s === focusSector)) {
      return `rgba(148,163,184,${0.08 + t * 0.45})`;
    }
    return 'rgba(255,255,255,0.01)';
  }
  return `rgba(148,163,184,${0.04 + t * 0.22})`;
}

function getLinkWidth(link) {
  if (hoverNode) {
    const sid = typeof link.source === 'object' ? link.source.id : link.source;
    const tid = typeof link.target === 'object' ? link.target.id : link.target;
    return (sid === hoverNode.id || tid === hoverNode.id) ? 1.8 : 0.1;
  }
  return Math.max(0.1, (link.r - 0.88) * 4);
}

// â”€â”€ í†µê³„ ì—…ë°ì´íŠ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateStats(nNodes, nLinks, simRunning) {
  const el = document.getElementById('stats');
  el.innerHTML =
    `<b>${nNodes.toLocaleString()}</b>ê°œ ë…¸ë“œ &nbsp;|&nbsp; <b>${nLinks.toLocaleString()}</b>ê°œ ì—£ì§€` +
    (simRunning ? `<br><span class="sim-running">âŸ³ ë ˆì´ì•„ì›ƒ ê³„ì‚° ì¤‘...</span>` : '');
}

function fmtAUM(b) {
  if (b >= 100) return `$${b.toFixed(0)}B`;
  if (b >= 1)   return `$${b.toFixed(1)}B`;
  if (b >= 0.1) return `$${(b * 1000).toFixed(0)}M`;
  return '<$100M';
}

// â”€â”€ ë ˆì „ë“œ ë Œë” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderLegend() {
  const AC_ORDER = ['EQUITY','FIXED_INCOME','REAL_ASSETS','ALTERNATIVE','THEMATIC'];
  const AC_KO = {
    EQUITY: 'ì£¼ì‹', FIXED_INCOME: 'ì±„ê¶Œ',
    REAL_ASSETS: 'ì‹¤ë¬¼ìì‚°', ALTERNATIVE: 'ëŒ€ì•ˆ', THEMATIC: 'í…Œë§ˆ'
  };
  const grouped = {};
  for (const [sid, s] of Object.entries(sectorMeta)) {
    (grouped[s.ac] = grouped[s.ac] || []).push({ sid, ...s });
  }

  let html = '';
  for (const ac of AC_ORDER) {
    if (!grouped[ac]) continue;
    html += `<div class="legend-ac">${AC_KO[ac]}</div>`;

    let renderedSS = new Set();
    for (const s of grouped[ac]) {
      const ss = s.ss;  // ìŠˆí¼ì„¹í„° ID (ìˆìœ¼ë©´)
      if (superSectorMode && ss && superSectorMeta[ss]) {
        // ìŠˆí¼ì„¹í„° í†µí•© í•­ëª© (ì²˜ìŒ í•œ ë²ˆë§Œ ë Œë”)
        if (!renderedSS.has(ss)) {
          renderedSS.add(ss);
          const ssDef = superSectorMeta[ss];
          html += `
            <div class="legend-item" data-sid="SS_${ss}" title="${ssDef.name_en}">
              <div class="legend-dot" style="background:${ssDef.color}"></div>
              <span class="legend-text">${ssDef.name}</span>
            </div>`;
        }
      } else {
        // ê°œë³„ ì„¹í„° í•­ëª©
        const color = (superSectorMode && ss && superSectorMeta[ss])
          ? superSectorMeta[ss].color : s.color;
        html += `
          <div class="legend-item" data-sid="${s.sid}" title="${s.name_en}">
            <div class="legend-dot" style="background:${color}"></div>
            <span class="legend-text">${s.name}</span>
          </div>`;
      }
    }
  }
  const container = document.getElementById('legend-items');
  container.innerHTML = html;

  container.addEventListener('click', e => {
    const item = e.target.closest('.legend-item');
    if (!item) return;
    const sid = item.dataset.sid;
    focusSector = focusSector === sid ? null : sid;
    container.querySelectorAll('.legend-item').forEach(el => {
      el.classList.remove('active', 'dimmed');
      if (focusSector) {
        if (el.dataset.sid === focusSector) el.classList.add('active');
        else el.classList.add('dimmed');
      }
    });
    if (Graph) Graph.refresh();
  });
}

// â”€â”€ í•„í„° ì ìš© (ìŠ¬ë¼ì´ë” ë³€ê²½ ì‹œ) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function applyFilter(minR) {
  currentR = minR;
  const visibleNodes = hideLegacy ? allNodes.filter(n => !n.l) : allNodes;
  const visibleIds   = new Set(visibleNodes.map(n => n.id));
  const filtered     = allLinks.filter(l => l.r >= minR && visibleIds.has(l.s) && visibleIds.has(l.t));
  Graph.graphData({ nodes: visibleNodes, links: filtered });

  // r=1 â†’ ê°€ê¹ê²Œ, râ‰ˆ0 â†’ ë©€ê²Œ  (graphData í˜¸ì¶œ í›„ ì§ì ‘ ì„¤ì •)
  const lf = Graph.d3Force('link');
  if (lf) {
    lf.distance(l => Math.max(5, (1 - (l.r || 0.9)) * LINK_DIST_K))
      .strength(l => Math.max(0, ((l.r || 0.9) - 0.8) * LINK_STRENGTH_K));
  }
  Graph.d3Force('charge').strength(-80);
  Graph.d3ReheatSimulation();

  updateStats(allNodes.length, filtered.length, true);
}

// â”€â”€ ë°ì´í„° ë¡œë“œ & ê·¸ë˜í”„ ì´ˆê¸°í™” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const progFill = document.getElementById('progress-fill');
progFill.style.width = '20%';

fetch('graph_data.json')
  .then(res => {
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    progFill.style.width = '55%';
    return res.json();
  })
  .then(data => {
    progFill.style.width = '85%';

    allNodes        = data.nodes;
    allLinks        = data.links;
    sectorMeta      = data.sectors;
    superSectorMeta = data.super_sectors || {};
    storeMinR       = data.meta.store_min_r;

    // ëŒ€ì‹œë³´ë“œ localStorage ì˜¤ë²„ë¼ì´ë“œ ë°˜ì˜
    try {
      const ov = JSON.parse(localStorage.getItem('corryu_user_overrides') || '{}');
      if (Object.keys(ov).length) {
        allNodes.forEach(node => {
          if (node.id in ov) node.l = ov[node.id].is_legacy ? 1 : 0;
        });
      }
    } catch(e) {}

    // ë ˆê±°ì‹œ ì¹´ìš´íŠ¸ í‘œì‹œ
    const legacyCount = allNodes.filter(n => n.l).length;
    document.getElementById('legacy-count').textContent = `(${legacyCount}ê°œ)`;

    // ìŠ¬ë¼ì´ë” ìµœì†Ÿê°’ ë™ê¸°í™”
    const slider = document.getElementById('r-slider');
    const minInt = Math.round(storeMinR * 100);
    slider.min = minInt;
    document.getElementById('r-min-label').textContent = storeMinR.toFixed(2);

    renderLegend();

    // â”€â”€ ForceGraph ì´ˆê¸°í™” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    Graph = ForceGraph()(document.getElementById('graph-container'))
      .backgroundColor('#0d1117')
      .nodeId('id')
      .linkSource('s')
      .linkTarget('t')
      .nodeLabel(() => '')          // ì»¤ìŠ¤í…€ íˆ´íŒ ì‚¬ìš©
      .nodeVal(getNodeVal)
      .nodeColor(getNodeColor)
      .onRenderFramePost((ctx, globalScale) => {
        const anchorNodes = (Graph.graphData().nodes || []).filter(n => n.anchor);
        if (!anchorNodes.length) return;
        const fontSize = Math.max(12, 14 / Math.max(1, Math.log2(globalScale + 1)));
        ctx.font = `800 ${fontSize}px 'SF Mono',Consolas,Menlo,monospace`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'top';
        anchorNodes.forEach(node => {
          const r = Math.sqrt(getNodeVal(node)) * 4;
          const x = node.x, y = node.y + r + 3;
          // ë°°ê²½ ë°•ìŠ¤
          const metrics = ctx.measureText(node.id);
          const tw = metrics.width, th = fontSize;
          const pad = 3;
          ctx.fillStyle = 'rgba(13,17,23,0.82)';
          ctx.fillRect(x - tw/2 - pad, y - pad/2, tw + pad*2, th + pad);
          // í…ìŠ¤íŠ¸
          ctx.fillStyle = '#ffffff';
          ctx.fillText(node.id, x, y);
        });
      })
      .linkColor(getLinkColor)
      .linkWidth(getLinkWidth)
      .linkCurvature(0)
      .d3AlphaDecay(0.04)
      .d3VelocityDecay(0.55)
      .d3AlphaMin(0.01)
      .cooldownTime(8000)
      .enableNodeDrag(true)
      .enableZoomInteraction(true)
      .onEngineStop(() => {
        const gd = Graph.graphData();
        updateStats(gd.nodes.length, gd.links.length, false);
      })
      .onNodeHover(node => {
        hoverNode = node || null;
        highlightNodeIds.clear();

        if (node) {
          highlightNodeIds.add(node.id);
          (Graph.graphData().links || []).forEach(l => {
            const s = typeof l.source === 'object' ? l.source.id : l.source;
            const t = typeof l.target === 'object' ? l.target.id : l.target;
            if (s === node.id || t === node.id) {
              highlightNodeIds.add(s);
              highlightNodeIds.add(t);
            }
          });

          // ì´ì›ƒ ìˆ˜ ê³„ì‚°
          const neighborCount = highlightNodeIds.size - 1;
          const sc = sectorMeta[node.s] || {};
          document.getElementById('tt-ticker').style.color = sc.color || '#e6edf3';
          document.getElementById('tt-ticker').textContent = node.id;
          document.getElementById('tt-name').textContent   = node.n;
          document.getElementById('tt-meta').innerHTML = `
            <div class="tt-row">
              <span class="tt-key">ì„¹í„°</span>
              <span class="tt-val" style="color:${sc.color}">${sc.name || node.s}</span>
            </div>
            <div class="tt-row">
              <span class="tt-key">AUM</span>
              <span class="tt-val">${fmtAUM(node.a)}</span>
            </div>
            <div class="tt-row">
              <span class="tt-key">ì—°ê²°(râ‰¥${currentR.toFixed(2)})</span>
              <span class="tt-val">${neighborCount}ê°œ</span>
            </div>`;
          document.getElementById('tooltip').style.display = 'block';
        } else {
          document.getElementById('tooltip').style.display = 'none';
        }
        requestAnimationFrame(() => { if (Graph) Graph.refresh(); });
      })
      .onNodeClick(node => {
        Graph.centerAt(node.x, node.y, 500);
        Graph.zoom(5, 500);
      })
      .onBackgroundClick(() => {
        if (focusSector) {
          focusSector = null;
          document.querySelectorAll('.legend-item').forEach(el => el.classList.remove('active', 'dimmed'));
          Graph.refresh();
        } else {
          Graph.zoomToFit(400, 40);
        }
      });

    progFill.style.width = '100%';
    setTimeout(() => { progFill.style.width = '0%'; }, 600);

    // ê¸°ë³¸ ì„ê³„ê°’ìœ¼ë¡œ ë°ì´í„° ì ìš©
    applyFilter(DEFAULT_R);
  })
  .catch(err => {
    console.error(err);
    document.getElementById('error-screen').classList.add('show');
  });

// â”€â”€ íˆ´íŒ ë§ˆìš°ìŠ¤ ì¶”ì  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('graph-container').addEventListener('mousemove', e => {
  const tt = document.getElementById('tooltip');
  if (tt.style.display === 'none') return;
  const x = e.clientX + 14;
  const y = e.clientY + 14;
  tt.style.left = (x + tt.offsetWidth  > window.innerWidth  ? x - tt.offsetWidth  - 28 : x) + 'px';
  tt.style.top  = (y + tt.offsetHeight > window.innerHeight ? y - tt.offsetHeight - 28 : y) + 'px';
});

// â”€â”€ ìŠ¬ë¼ì´ë” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('r-slider').addEventListener('input', e => {
  const v = parseInt(e.target.value) / 100;
  document.getElementById('r-val').textContent = v.toFixed(2);
  applyFilter(v);
});

// â”€â”€ ë ˆê±°ì‹œ í† ê¸€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('hide-legacy').addEventListener('change', e => {
  hideLegacy = e.target.checked;
  if (Graph) applyFilter(currentR);
});

// â”€â”€ ìŠˆí¼ì„¹í„° í† ê¸€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('super-sector-toggle').addEventListener('change', e => {
  superSectorMode = e.target.checked;
  focusSector = null;  // í¬ì»¤ìŠ¤ ì´ˆê¸°í™”
  if (Graph) {
    renderLegend();  // ë ˆì „ë“œ ì¬ë Œë” (ìŠˆí¼ì„¹í„°/ì„œë¸Œì„¹í„° í•­ëª© ì „í™˜)
    Graph.refresh();
  }
});

// â”€â”€ ê²€ìƒ‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('search').addEventListener('input', e => {
  searchTicker = e.target.value.trim().toUpperCase();
  if (!Graph) return;
  if (searchTicker) {
    const gNode = (Graph.graphData().nodes || []).find(n => n.id === searchTicker);
    if (gNode && gNode.x != null) {
      Graph.centerAt(gNode.x, gNode.y, 500);
      Graph.zoom(6, 500);
    }
  }
  Graph.refresh();
});
</script>
</body>
</html>
