<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CORRYU Master Valuation Dashboard</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
<link href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root { --bg-primary: #0a0d14; --bg-card: rgba(20,24,38,0.85); --bg-hover: rgba(59,130,246,0.08); --border: rgba(255,255,255,0.07); --text-primary: #e2e8f0; --text-muted: #64748b; --accent: #3b82f6; --accent-glow: rgba(59,130,246,0.3); }
* { box-sizing: border-box; }
body { background-color: var(--bg-primary); color: var(--text-primary); font-family: 'Inter', -apple-system, sans-serif; margin: 0; padding: 16px; }
.glass { background: var(--bg-card); backdrop-filter: blur(16px); border: 1px solid var(--border); border-radius: 14px; }
.text-gradient { background: linear-gradient(135deg, #60a5fa 0%, #a78bfa 50%, #f472b6 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 800; }

/* Asset Class Tabs */
.ac-tab { padding: 8px 18px; border-radius: 10px; background: transparent; color: var(--text-muted); border: 1px solid transparent; font-weight: 600; font-size: 0.9rem; cursor: pointer; transition: all 0.2s; white-space: nowrap; }
.ac-tab:hover { color: var(--text-primary); background: var(--bg-hover); }
.ac-tab.active { background: var(--accent); color: #fff; border-color: var(--accent); box-shadow: 0 0 20px var(--accent-glow); }

/* Sector Tabs */
.sec-tab { padding: 6px 14px; border-radius: 8px; background: rgba(255,255,255,0.03); color: var(--text-muted); border: 1px solid rgba(255,255,255,0.06); font-weight: 500; font-size: 0.82rem; cursor: pointer; transition: all 0.15s; white-space: nowrap; margin: 3px; }
.sec-tab:hover { color: var(--text-primary); border-color: rgba(255,255,255,0.15); }
.sec-tab.active { background: rgba(59,130,246,0.15); color: #93c5fd; border-color: rgba(59,130,246,0.4); }
.sec-tab .sec-count { font-size: 0.7rem; opacity: 0.6; margin-left: 4px; }
/* Super-sector tab */
.super-sec-tab { background: rgba(59,130,246,0.07); border-color: rgba(59,130,246,0.2); color: #93c5fd; }
.super-sec-tab:hover { background: rgba(59,130,246,0.15); border-color: rgba(59,130,246,0.4); }
.super-sec-tab.active { background: rgba(59,130,246,0.22); color: #fff; border-color: rgba(59,130,246,0.6); box-shadow: 0 0 12px rgba(59,130,246,0.2); }
/* Sub-sector tabs row */
#subSecTabs { display:none; padding: 6px 0 2px 0; border-top: 1px solid rgba(59,130,246,0.15); margin-top: 4px; }
.sub-sec-tab { font-size: 0.77rem; padding: 4px 11px; }
.expand-arrow { font-size: 0.65rem; margin-left: 4px; opacity: 0.7; }

/* Summary Cards */
.stat-card { display: flex; flex-direction: column; align-items: center; padding: 12px 8px; background: rgba(10,13,20,0.5); border-radius: 10px; border: 1px solid var(--border); min-width: 90px; }
.stat-card .stat-value { font-size: 1.3rem; font-weight: 700; }
.stat-card .stat-label { font-size: 0.7rem; color: var(--text-muted); margin-top: 4px; text-transform: uppercase; letter-spacing: 0.5px; }

/* DataTables Override */
table.dataTable { border-collapse: collapse; width: 100%; color: #cbd5e1; font-size: 0.88rem; }
table.dataTable thead th { background: rgba(20,24,38,0.95); color: #64748b; border-bottom: 2px solid rgba(255,255,255,0.08); padding: 10px 8px; font-weight: 600; font-size: 0.78rem; text-align: right; text-transform: uppercase; letter-spacing: 0.3px; }
table.dataTable tbody td { border-bottom: 1px solid rgba(255,255,255,0.04); padding: 10px 8px; text-align: right; }
table.dataTable tbody tr:hover { background-color: var(--bg-hover) !important; }
table.dataTable thead th.text-left, table.dataTable tbody td.text-left { text-align: left !important; }
.dataTables_wrapper .dataTables_filter input { color: white; background: rgba(20,24,38,0.95); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 6px 14px; font-size: 0.85rem; }
.dataTables_wrapper .dataTables_filter input:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 8px var(--accent-glow); }
.dataTables_wrapper .dataTables_length select { color: white; background: rgba(20,24,38,0.95); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; padding: 4px; }
.dataTables_wrapper .dataTables_info, .dataTables_wrapper .dataTables_paginate { color: var(--text-muted); font-size: 0.8rem; padding-top: 12px; }
.dataTables_wrapper .dataTables_paginate .paginate_button { color: var(--text-muted) !important; border: 1px solid rgba(255,255,255,0.06) !important; border-radius: 6px !important; background: transparent !important; margin: 0 2px; }
.dataTables_wrapper .dataTables_paginate .paginate_button.current { background: var(--accent) !important; color: #fff !important; border-color: var(--accent) !important; }

/* Legacy badge */
.badge-legacy { display: inline-flex; align-items: center; gap: 3px; padding: 2px 8px; border-radius: 6px; font-size: 0.72rem; font-weight: 600; background: rgba(239,68,68,0.12); color: #f87171; border: 1px solid rgba(239,68,68,0.2); }
.badge-active { display: inline-flex; align-items: center; padding: 2px 8px; border-radius: 6px; font-size: 0.72rem; font-weight: 600; background: rgba(34,197,94,0.1); color: #4ade80; border: 1px solid rgba(34,197,94,0.15); }
.badge-short { display: inline-flex; align-items: center; padding: 2px 6px; border-radius: 4px; font-size: 0.65rem; font-weight: 600; background: rgba(234,179,8,0.12); color: #facc15; border: 1px solid rgba(234,179,8,0.2); margin-left: 4px; }
.tag { display: inline-block; padding: 1px 6px; border-radius: 4px; font-size: 0.65rem; font-weight: 600; margin: 1px; }
.value-up { color: #f87171; } .value-down { color: #60a5fa; }
.row-legacy td { opacity: 0.45; text-decoration: line-through; }
.mine-badge { background: linear-gradient(135deg, #fbbf24, #f59e0b); color: #000; padding: 2px 8px; border-radius: 4px; font-size: 0.68rem; font-weight: 800; box-shadow: 0 0 10px rgba(251,191,36,0.4); }
.badge-user-legacy { display: inline-flex; align-items: center; gap: 3px; padding: 2px 8px; border-radius: 6px; font-size: 0.72rem; font-weight: 600; background: rgba(249,115,22,0.12); color: #fb923c; border: 1px solid rgba(249,115,22,0.3); }
.badge-user-sector { display: inline-flex; align-items: center; gap: 3px; padding: 2px 7px; border-radius: 5px; font-size: 0.68rem; font-weight: 600; background: rgba(139,92,246,0.12); color: #a78bfa; border: 1px solid rgba(139,92,246,0.25); }

/* Checkbox column */
input.row-cb { width: 15px; height: 15px; cursor: pointer; accent-color: #3b82f6; vertical-align: middle; }
input#select-all-cb { width: 15px; height: 15px; cursor: pointer; accent-color: #3b82f6; }
table.dataTable tbody tr.row-selected { background: rgba(59,130,246,0.08) !important; outline: 1px solid rgba(59,130,246,0.2); }

/* FAB */
#fab { position: fixed; bottom: 28px; right: 28px; z-index: 9999; display: none; animation: fabIn 0.18s ease; }
@keyframes fabIn { from { opacity:0; transform: translateY(10px); } to { opacity:1; transform: translateY(0); } }
#fab-card { background: rgba(20,24,38,0.97); border: 1px solid rgba(59,130,246,0.4); border-radius: 14px; padding: 12px 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.5), 0 0 0 1px rgba(59,130,246,0.1); backdrop-filter: blur(16px); min-width: 260px; }
#fab-label { font-size: 0.78rem; color: #64748b; margin-bottom: 10px; }
#fab-count { color: #93c5fd; font-weight: 700; }
.fab-btn { display: inline-flex; align-items: center; gap: 5px; padding: 7px 14px; border-radius: 8px; font-size: 0.82rem; font-weight: 600; border: none; cursor: pointer; transition: all 0.15s; }
#fab-btn-legacy { background: rgba(239,68,68,0.15); color: #f87171; border: 1px solid rgba(239,68,68,0.3); }
#fab-btn-legacy:hover { background: rgba(239,68,68,0.28); }
#fab-btn-unlegacy { background: rgba(34,197,94,0.12); color: #4ade80; border: 1px solid rgba(34,197,94,0.25); }
#fab-btn-unlegacy:hover { background: rgba(34,197,94,0.22); }
#fab-btn-move { background: rgba(139,92,246,0.15); color: #a78bfa; border: 1px solid rgba(139,92,246,0.3); }
#fab-btn-move:hover { background: rgba(139,92,246,0.28); }
#fab-btn-clear { background: rgba(255,255,255,0.05); color: #64748b; border: 1px solid rgba(255,255,255,0.08); padding: 7px 10px; }
#fab-btn-clear:hover { background: rgba(255,255,255,0.1); color: #94a3b8; }

/* ì¹´í…Œê³ ë¦¬ ì´ë™ ëª¨ë‹¬ */
#sector-modal { display:none; position:fixed; inset:0; z-index:10000; background:rgba(0,0,0,0.72); backdrop-filter:blur(4px); align-items:center; justify-content:center; }
#sector-modal.show { display:flex; }
#sector-modal-card { background:#0f1623; border:1px solid rgba(139,92,246,0.4); border-radius:16px; padding:24px; width:min(580px,95vw); max-height:82vh; overflow-y:auto; box-shadow:0 24px 64px rgba(0,0,0,0.7); }
.smb { display:flex; align-items:center; gap:8px; padding:9px 12px; border-radius:8px; border:1px solid rgba(255,255,255,0.07); background:rgba(255,255,255,0.03); color:#cbd5e1; font-size:0.82rem; cursor:pointer; transition:all 0.15s; width:100%; text-align:left; }
.smb:hover { background:rgba(139,92,246,0.15); border-color:rgba(139,92,246,0.4); color:#e2e8f0; }
.smb.cur { border-color:rgba(59,130,246,0.5); background:rgba(59,130,246,0.1); color:#93c5fd; }
.smg { font-size:0.7rem; font-weight:700; text-transform:uppercase; letter-spacing:0.8px; color:#334155; padding:14px 0 5px 2px; }

/* History buttons */
.btn-history { display: inline-flex; align-items: center; gap: 4px; padding: 5px 10px; border-radius: 7px; font-size: 0.78rem; font-weight: 600; border: 1px solid rgba(255,255,255,0.08); background: rgba(255,255,255,0.04); color: #94a3b8; cursor: pointer; transition: all 0.15s; }
.btn-history:hover:not(:disabled) { background: rgba(255,255,255,0.1); color: #e2e8f0; }
.btn-history:disabled { opacity: 0.3; cursor: not-allowed; }
#btn-reset { color: #fbbf24; border-color: rgba(251,191,36,0.2); background: rgba(251,191,36,0.05); }
#btn-reset:hover { background: rgba(251,191,36,0.12) !important; color: #fde68a !important; }

/* ë™ê¸°í™” ìƒíƒœ dot */
.sync-dot { width: 7px; height: 7px; border-radius: 50%; background: #475569; display: inline-block; flex-shrink: 0; }
.sync-dot.ok { background: #4ade80; }
.sync-dot.err { background: #f87171; }
.sync-dot.busy { background: #fbbf24; animation: syncPulse 1s ease-in-out infinite; }
@keyframes syncPulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.35; } }

/* í”Œë¡œíŒ… ì €ì¥ ë²„íŠ¼ */
#save-float { position: fixed; bottom: 28px; left: 28px; z-index: 9998; display: none; animation: fabIn 0.18s ease; }
#save-float.visible { display: block; }
#save-float-btn { display: inline-flex; align-items: center; gap: 8px; padding: 11px 20px; border-radius: 12px; font-size: 0.85rem; font-weight: 700; cursor: pointer; transition: background 0.2s, color 0.2s, border-color 0.2s; backdrop-filter: blur(14px); box-shadow: 0 4px 24px rgba(0,0,0,0.45); border: 1px solid rgba(59,130,246,0.45); background: rgba(59,130,246,0.18); color: #93c5fd; }
#save-float-btn:hover:not(:disabled) { background: rgba(59,130,246,0.32); }
#save-float-btn:disabled { cursor: not-allowed; }
#save-float-btn.state-saving { color: #fbbf24; border-color: rgba(251,191,36,0.4); background: rgba(251,191,36,0.1); }
#save-float-btn.state-saved  { color: #4ade80; border-color: rgba(74,222,128,0.4);  background: rgba(74,222,128,0.1); }
#save-float-btn.state-error  { color: #f87171; border-color: rgba(248,113,113,0.4); background: rgba(248,113,113,0.1); }

/* Filter controls */
.filter-input { background: rgba(20,24,38,0.95); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #e2e8f0; padding: 6px 10px; font-size: 0.82rem; width: 90px; }
.filter-input:focus { outline: none; border-color: var(--accent); }
.filter-check { accent-color: var(--accent); width: 16px; height: 16px; cursor: pointer; }

/* Tooltip */
.tooltip-container { position: relative; cursor: help; }
.tooltip-content { display: none; position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); background: #1e293b; color: #e2e8f0; padding: 8px 12px; border-radius: 8px; font-size: 0.75rem; white-space: nowrap; z-index: 999; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 4px 12px rgba(0,0,0,0.5); max-width: 350px; white-space: normal; }
.tooltip-container:hover .tooltip-content { display: block; }
</style>
</head>
<body>
<div class="max-w-screen-2xl mx-auto">
    <!-- Header -->
    <div class="glass p-5 mb-5 text-center relative overflow-hidden">
        <div class="absolute top-0 left-0 w-full h-0.5" style="background: linear-gradient(90deg, #3b82f6, #8b5cf6, #ec4899, #f59e0b);"></div>
        <div class="absolute top-4 right-4" style="display:flex;gap:8px;align-items:center">
            <button id="lang-switcher" onclick="I18n.setLocale(I18n.locale()==='ko'?'en':'ko')" style="padding:5px 12px;border-radius:8px;background:rgba(255,255,255,0.06);color:#94a3b8;border:1px solid rgba(255,255,255,0.1);font-size:0.78rem;font-weight:700;cursor:pointer;letter-spacing:0.05em;transition:all 0.15s;" onmouseover="this.style.background='rgba(255,255,255,0.12)'" onmouseout="this.style.background='rgba(255,255,255,0.06)'">EN</button>
            <a href="graph.html" style="display:inline-flex;align-items:center;gap:6px;padding:7px 16px;border-radius:10px;background:rgba(139,92,246,0.15);color:#a78bfa;border:1px solid rgba(139,92,246,0.35);font-size:0.82rem;font-weight:600;text-decoration:none;transition:all 0.2s;" onmouseover="this.style.background='rgba(139,92,246,0.28)'" onmouseout="this.style.background='rgba(139,92,246,0.15)'">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2"><circle cx="5" cy="12" r="2"/><circle cx="19" cy="5" r="2"/><circle cx="19" cy="19" r="2"/><line x1="7" y1="11.5" x2="17" y2="6.5"/><line x1="7" y1="12.5" x2="17" y2="17.5"/></svg>
                <span data-i18n="btn.viewGraph">ê·¸ë˜í”„ ë³´ê¸°</span>
            </a>
        </div>
        <h1 class="text-2xl md:text-3xl font-extrabold mb-2 tracking-tight">
            <span class="text-gradient">CORRYU</span> Master Valuation Dashboard
        </h1>
        <p class="text-sm text-gray-500">
            Total <span class="text-white font-bold" id="hdr-total">1,651</span> ETFs
            <span class="text-gray-600" id="hdr-legacy-label">(<span id="hdr-legacy">671</span> legacy, <span class="text-green-400 font-bold" id="hdr-active">980</span> active)</span> |
            <span class="text-white font-bold">23</span> Sectors |
            Updated: <span class="text-gray-400">2026-02-26</span>
        </p>
    </div>

    <!-- Asset Class Tabs (Level 1) -->
    <div class="glass p-4 mb-4">
        <div class="flex items-center gap-2 overflow-x-auto pb-1" id="acTabs">
            <button class="ac-tab active" data-ac="ALL">ì „ì²´</button>
        </div>
    </div>

    <!-- Sector Tabs (Level 2) + Sub-sector Tabs (Level 3) -->
    <div class="glass p-4 mb-4">
        <div class="flex flex-wrap" id="secTabs"></div>
        <div class="flex flex-wrap" id="subSecTabs"></div>
    </div>

    <!-- Sector Summary + Filters -->
    <div class="glass p-4 mb-4">
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
            <!-- Summary Cards -->
            <div class="flex items-center gap-3 overflow-x-auto" id="summaryCards">
            </div>
            <!-- Filters -->
            <div class="flex flex-wrap items-center gap-3 text-sm">
                <label class="flex items-center gap-1.5 text-gray-400 cursor-pointer">
                    <input type="checkbox" id="filterLegacy" class="filter-check">
                    <span data-i18n="filter.hideLegacy">Legacy ìˆ¨ê¸°ê¸°</span>
                </label>
                <label class="flex items-center gap-1.5 text-gray-400 cursor-pointer">
                    <input type="checkbox" id="filterShort" class="filter-check">
                    <span data-i18n="filter.hideShortHistory">ì§§ì€ì—°í˜ ìˆ¨ê¸°ê¸°</span>
                </label>
                <div class="flex items-center gap-1.5 text-gray-400">
                    <span>Min AUM</span>
                    <input type="number" id="filterAum" class="filter-input" placeholder="$M" value="0">
                    <span>M$</span>
                </div>
                <div class="flex items-center gap-1.5 text-gray-400">
                    <span>Min Sortino</span>
                    <input type="number" id="filterSortino" class="filter-input" placeholder="0" value="" step="0.1">
                </div>
                <div style="border-left:1px solid rgba(255,255,255,0.1);padding-left:12px;display:flex;gap:6px;align-items:center">
                    <button id="btn-undo" class="btn-history" disabled title="Ctrl+Z" data-i18n="btn.undo">â†© ì‹¤í–‰ì·¨ì†Œ</button>
                    <button id="btn-reset" class="btn-history" data-i18n="btn.reset" data-i18n-title="btn.reset.title">âŸ³ ì´ˆê¸°í™”</button>
                    <button id="sync-status" class="btn-history" data-i18n-title="btn.sync.title"><span class="sync-dot" id="sync-dot"></span>&nbsp;<span id="sync-label" data-i18n="btn.sync">ë™ê¸°í™”</span></button>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Table -->
    <div class="glass p-4" style="position:relative;overflow-x:auto">
        <table id="masterTable" class="display nowrap" style="width:100%">
            <thead>
                <tr>
                    <th style="width:28px;min-width:28px;text-align:center !important"><input type="checkbox" id="select-all-cb"></th>
                    <th data-i18n-title="col.no.tip" style="width:36px;min-width:36px">#</th>
                    <th class="text-left">Ticker</th>
                    <th class="text-left" style="min-width:220px" data-i18n="col.name">ETF ëª…ì¹­</th>
                    <th>Rank</th>
                    <th>AUM</th>
                    <th data-i18n-title="col.rAnchor.tip">r_Anchor</th>
                    <th data-i18n-title="col.rSmh.tip">SMH Corr</th>
                    <th data-i18n-title="col.zScore.tip">Z-Score</th>
                    <th data-i18n-title="col.ma200.tip">200MA</th>
                    <th data-i18n-title="col.rsi.tip">RSI</th>
                    <th data-i18n-title="col.range52w.tip">52W Rng</th>
                    <th data-i18n-title="col.mdd52w.tip">52W MDD</th>
                    <th data-i18n-title="col.cagr.tip">CAGR</th>
                    <th data-i18n-title="col.vol.tip">Vol</th>
                    <th data-i18n-title="col.sortino.tip">Sortino</th>
                    <th data-i18n-title="col.inception.tip">Inception</th>
                    <th data-i18n-title="col.status.tip" style="min-width:80px">Status</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<!-- í”Œë¡œíŒ… ì €ì¥ ë²„íŠ¼ -->
<div id="save-float">
    <button id="save-float-btn" onclick="manualSyncSave()">
        <span id="save-float-icon">â˜</span>
        <span id="save-float-label" data-i18n="save.dirty">ì €ì¥</span>
    </button>
</div>

<!-- FAB: ë ˆê±°ì‹œ ì²˜ë¦¬/í•´ì œ/ì¹´í…Œê³ ë¦¬ ì´ë™ -->
<div id="fab">
    <div id="fab-card">
        <div id="fab-label" id="fab-label-div"></div>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <button class="fab-btn" id="fab-btn-legacy" data-i18n="btn.legacy.mark">ë ˆê±°ì‹œ ì²˜ë¦¬</button>
            <button class="fab-btn" id="fab-btn-unlegacy" data-i18n="btn.legacy.unmark">ë ˆê±°ì‹œ í•´ì œ</button>
            <button class="fab-btn" id="fab-btn-move" data-i18n="btn.move">â†ª ì¹´í…Œê³ ë¦¬ ì´ë™</button>
            <button class="fab-btn" id="fab-btn-clear" data-i18n="btn.clear">Ã—</button>
        </div>
    </div>
</div>

<!-- ì¹´í…Œê³ ë¦¬ ì´ë™ ëª¨ë‹¬ -->
<div id="sector-modal">
    <div id="sector-modal-card">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:18px">
            <div>
                <div style="font-weight:700;font-size:1rem;color:#e2e8f0" data-i18n="fab.move.title">â†ª ì¹´í…Œê³ ë¦¬ ì´ë™</div>
                <div style="font-size:0.78rem;color:#64748b;margin-top:3px" id="modal-sel-info"></div>
            </div>
            <button id="sector-modal-close" style="background:transparent;border:none;color:#475569;font-size:1.3rem;cursor:pointer;line-height:1;padding:2px 6px" title="ë‹«ê¸°">Ã—</button>
        </div>
        <div id="sector-modal-body"></div>
    </div>
</div>


<script src="/i18n.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script>
// sectorMeta, allDataëŠ” etf_data.jsonì—ì„œ fetchë¡œ ë¡œë“œë©ë‹ˆë‹¤
let sectorMeta = {};
let allData = {};
const acSectors = {"EQUITY": ["S01", "S02", "S03", "S04", "S05", "S06", "S07", "S08", "S09", "S10", "S11", "S12", "S13"], "FIXED_INCOME": ["S14", "S15", "S16", "S17"], "REAL_ASSETS": ["S18", "S19", "S20"], "ALTERNATIVE": ["S21", "S22"], "THEMATIC": ["S24"]};

// â”€â”€ ì²´í¬ë°•ìŠ¤ ì„ íƒ ìƒíƒœ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const selectedTickers = new Set();

// â”€â”€ localStorage ë ˆê±°ì‹œ ì˜¤ë²„ë¼ì´ë“œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const USER_OVERRIDES_KEY = 'corryu_user_overrides';

function getUserOverrides() {
    try { return JSON.parse(localStorage.getItem(USER_OVERRIDES_KEY) || '{}'); }
    catch(e) { return {}; }
}
function saveUserOverrides(ov) {
    localStorage.setItem(USER_OVERRIDES_KEY, JSON.stringify(ov));
    localStorage.setItem('corryu_overrides_ts', String(Date.now()));
    _syncDirty = true;
    setSaveFloat('dirty');
    pushRemoteOverrides(ov);  // async, non-blocking
}

function applyUserOverrides() {
    const ov = getUserOverrides();
    if (!Object.keys(ov).length) return;
    applyOverridesToData(ov);
}
const acDefs = {"EQUITY": {"name": "ì£¼ì‹", "name_en": "Equity", "icon": "ğŸ“ˆ", "order": 1}, "FIXED_INCOME": {"name": "ì±„ê¶Œ", "name_en": "Fixed Income", "icon": "ğŸ›¡ï¸", "order": 2}, "REAL_ASSETS": {"name": "ì‹¤ë¬¼ìì‚°", "name_en": "Real Assets", "icon": "ğŸ—ï¸", "order": 3}, "ALTERNATIVE": {"name": "ëŒ€ì•ˆ", "name_en": "Alternatives", "icon": "âš¡", "order": 4}, "THEMATIC": {"name": "í…Œë§ˆ", "name_en": "Thematic", "icon": "ğŸ§©", "order": 5}};
const sectorDefs = {"S01": {"name": "US ëŒ€í˜•ì£¼ ì¢…í•©", "name_en": "US Large Cap", "icon": "ğŸ‡ºğŸ‡¸", "anchor": "VOO", "asset_class": "EQUITY", "super_sector": "EQUITY_MARKET"}, "S02": {"name": "í…Œí¬ë†€ë¡œì§€", "name_en": "Technology", "icon": "ğŸ’»", "anchor": "XLK", "asset_class": "EQUITY", "super_sector": "EQUITY_MARKET"}, "S03": {"name": "í—¬ìŠ¤ì¼€ì–´", "name_en": "Healthcare", "icon": "ğŸ¥", "anchor": "XLV", "asset_class": "EQUITY", "super_sector": null}, "S04": {"name": "ê¸ˆìœµ", "name_en": "Financials", "icon": "ğŸ¦", "anchor": "XLF", "asset_class": "EQUITY", "super_sector": "EQUITY_MARKET"}, "S05": {"name": "ê²½ê¸°ì†Œë¹„ì¬", "name_en": "Consumer Discretionary", "icon": "ğŸ›ï¸", "anchor": "XLY", "asset_class": "EQUITY", "super_sector": null}, "S06": {"name": "í•„ìˆ˜ì†Œë¹„ì¬", "name_en": "Consumer Staples", "icon": "ğŸ›’", "anchor": "XLP", "asset_class": "EQUITY", "super_sector": null}, "S07": {"name": "ì‚°ì—…ì¬", "name_en": "Industrials", "icon": "ğŸ­", "anchor": "XLI", "asset_class": "EQUITY", "super_sector": "EQUITY_MARKET"}, "S08": {"name": "ìœ í‹¸ë¦¬í‹°", "name_en": "Utilities", "icon": "âš¡", "anchor": "XLU", "asset_class": "EQUITY", "super_sector": null}, "S09": {"name": "ì»¤ë®¤ë‹ˆì¼€ì´ì…˜", "name_en": "Communication", "icon": "ğŸ“¡", "anchor": "XLC", "asset_class": "EQUITY", "super_sector": "EQUITY_MARKET"}, "S10": {"name": "ì†Œì¬", "name_en": "Materials", "icon": "â›ï¸", "anchor": "XLB", "asset_class": "EQUITY", "super_sector": null}, "S11": {"name": "êµ­ì œì„ ì§„êµ­", "name_en": "Intl Developed", "icon": "ğŸŒ", "anchor": "VEA", "asset_class": "EQUITY", "super_sector": "EQUITY_MARKET"}, "S12": {"name": "ì‹ í¥êµ­", "name_en": "Emerging Markets", "icon": "ğŸŒ", "anchor": "VWO", "asset_class": "EQUITY", "super_sector": null}, "S13": {"name": "ì¤‘ì†Œí˜•ì£¼", "name_en": "Small/Mid Cap", "icon": "ğŸ“Š", "anchor": "IWM", "asset_class": "EQUITY", "super_sector": "EQUITY_MARKET"}, "S14": {"name": "íˆ¬ìë“±ê¸‰ ì±„ê¶Œ", "name_en": "Investment Grade", "icon": "ğŸ›ï¸", "anchor": "BND", "asset_class": "FIXED_INCOME", "super_sector": null}, "S15": {"name": "ë‹¨ê¸°ì±„/í˜„ê¸ˆì„±", "name_en": "Short-Term/Cash", "icon": "ğŸ’µ", "anchor": "SHV", "asset_class": "FIXED_INCOME", "super_sector": null}, "S16": {"name": "í•˜ì´ì¼ë“œ/ì‹ í¥ì±„", "name_en": "High Yield/EM Debt", "icon": "âš ï¸", "anchor": "HYG", "asset_class": "FIXED_INCOME", "super_sector": null}, "S17": {"name": "TIPS/ì¸í”Œë ˆì´ì…˜", "name_en": "TIPS/Inflation", "icon": "ğŸ“ˆ", "anchor": "SCHP", "asset_class": "FIXED_INCOME", "super_sector": null}, "S18": {"name": "ê¸ˆ/ê·€ê¸ˆì†", "name_en": "Gold/Precious Metals", "icon": "âœ¨", "anchor": "GLD", "asset_class": "REAL_ASSETS", "super_sector": null}, "S19": {"name": "ì—ë„ˆì§€/ì›ìì¬", "name_en": "Energy/Commodities", "icon": "ğŸ›¢ï¸", "anchor": "XLE", "asset_class": "REAL_ASSETS", "super_sector": null}, "S20": {"name": "ë¶€ë™ì‚°/REITs", "name_en": "Real Estate/REITs", "icon": "ğŸ˜ï¸", "anchor": "VNQ", "asset_class": "REAL_ASSETS", "super_sector": null}, "S21": {"name": "ê°€ìƒìì‚°", "name_en": "Crypto/Digital", "icon": "â‚¿", "anchor": "GBTC", "asset_class": "ALTERNATIVE", "super_sector": null}, "S22": {"name": "ì¸ë²„ìŠ¤/ìˆ", "name_en": "Inverse/Short", "icon": "ğŸ“‰", "anchor": "SQQQ", "asset_class": "ALTERNATIVE", "super_sector": null}, "S24": {"name": "í…Œë§ˆ/íŠ¹ìˆ˜ëª©ì ", "name_en": "Thematic/Specialty", "icon": "ğŸ§©", "anchor": "â€”", "asset_class": "THEMATIC", "super_sector": null}};
const superSectorDefs = {"EQUITY_MARKET": {"name": "ì£¼ì‹ ì‹œì¥", "name_en": "Equity Market", "anchor": "QQQ", "icon": "ğŸŒ", "color": "#3b82f6", "sub_sectors": ["S01", "S02", "S04", "S07", "S09", "S11", "S13"]}};
const myPortfolio = ["PEY", "HYG", "GBTC", "GLD", "VNQ", "UYR", "XLE"];

// ì„¹í„°ID â†’ ìŠˆí¼ì„¹í„°ID ì—­ë°©í–¥ ë§µ
const sectorToSuperSector = {};
for (const [ssId, ss] of Object.entries(superSectorDefs)) {
    for (const sid of ss.sub_sectors) sectorToSuperSector[sid] = ssId;
}

let state = {
    activeAC: 'ALL',
    activeSector: 'ALL',       // 'ALL' | ì„¹í„°ID | 'SS_<ssId>' (ìŠˆí¼ì„¹í„° ì „ì²´)
    expandedSuperSector: null, // null | ìŠˆí¼ì„¹í„°ID (ì„œë¸Œíƒ­ í‘œì‹œ ì—¬ë¶€)
    hideLegacy: false,
    hideShort: false,
    minAum: 0,
    minSortino: -999
};

let table;


function formatMCap(val) {
    if (!val) return '-';
    let m = val / 1e6;
    if (m >= 1000) return '$' + (m/1000).toFixed(1) + 'B';
    return '$' + Math.round(m) + 'M';
}

// ë¡œì¼€ì¼ì— ë”°ë¼ ì„¹í„°/ìì‚°êµ° ì´ë¦„ ë°˜í™˜
function sName(def) {
    return (I18n.locale() === 'ko' || !def.name_en) ? def.name : def.name_en;
}

function renderACTabs() {
    let html = '<button class="ac-tab' + (state.activeAC === 'ALL' ? ' active' : '') + '" data-ac="ALL">ì „ì²´</button>';
    let ordered = Object.entries(acDefs).sort((a,b) => a[1].order - b[1].order);
    for (let [ac, def] of ordered) {
        let isActive = state.activeAC === ac ? ' active' : '';
        html += '<button class="ac-tab' + isActive + '" data-ac="' + ac + '">' + def.icon + ' ' + sName(def) + '</button>';
    }
    $('#acTabs').html(html);
}

function getSuperSectorMeta(ssId) {
    let ss = superSectorDefs[ssId];
    if (!ss) return {};
    let metas = ss.sub_sectors.map(sid => sectorMeta[sid] || {});
    return {
        count:  metas.reduce((s,m) => s+(m.count||0), 0),
        active: metas.reduce((s,m) => s+(m.active||0), 0),
        legacy: metas.reduce((s,m) => s+(m.legacy||0), 0),
    };
}

function recalcSectorMeta() {
    for (const sid of Object.keys(sectorMeta)) {
        const etfs = allData[sid] || [];
        sectorMeta[sid].count  = etfs.length;
        sectorMeta[sid].active = etfs.filter(e => !e.is_legacy).length;
        sectorMeta[sid].legacy = etfs.filter(e =>  e.is_legacy).length;
    }
    let totalETFs   = Object.values(sectorMeta).reduce((s,m) => s+(m.count||0),  0);
    let totalActive = Object.values(sectorMeta).reduce((s,m) => s+(m.active||0), 0);
    let totalLegacy = Object.values(sectorMeta).reduce((s,m) => s+(m.legacy||0), 0);
    $('#hdr-total').text(totalETFs.toLocaleString());
    $('#hdr-active').text(totalActive.toLocaleString());
    $('#hdr-legacy').text(totalLegacy.toLocaleString());
}

// â”€â”€ ì‹¤í–‰ì·¨ì†Œ íˆìŠ¤í† ë¦¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let undoHistory = [];
const MAX_UNDO_STEPS = 30;
let originalLegacyState = {};
let originalSectorState = {};  // { ticker: sid } â€” ë¹Œë“œ ê¸°ë³¸ ì„¹í„° ìŠ¤ëƒ…ìƒ·

function applySmhCorr() {
    try {
        const smhData = JSON.parse(localStorage.getItem('corryu_smh_corr') || 'null');
        if (!smhData) return;
        for (const sid of Object.keys(allData)) {
            for (const etf of allData[sid]) {
                if (etf.ticker in smhData) etf.smh_corr = smhData[etf.ticker];
            }
        }
    } catch(e) {}
}

function snapshotOriginalLegacy() {
    for (const sid of Object.keys(allData)) {
        for (const etf of allData[sid]) {
            originalLegacyState[etf.ticker] = {
                is_legacy:      etf.is_legacy,
                legacy_detail:  (etf.legacy_detail  || []).slice(),
                legacy_reasons: (etf.legacy_reasons || []).slice(),
                r_anchor:       etf.r_anchor
            };
            originalSectorState[etf.ticker] = sid;  // ë¹Œë“œ ê¸°ë³¸ ì„¹í„° ì €ì¥
        }
    }
}

// ëª¨ë“  ì„¹í„°ì—ì„œ tickerë¡œ ETF ê²€ìƒ‰ â†’ { etf, sid } | null
function findETFAnywhere(ticker) {
    for (const sid of Object.keys(allData)) {
        const idx = allData[sid].findIndex(e => e.ticker === ticker);
        if (idx !== -1) return { etf: allData[sid][idx], sid, idx };
    }
    return null;
}

function applyOverridesToData(ov) {
    // â‘  í˜„ì¬ ëª¨ë“  ì„¹í„°ì— ìˆëŠ” ETF ìˆ˜ì§‘ (ì´ë™ëì„ ìˆ˜ë„ ìˆìŒ)
    const etfMap = {};
    for (const sid of Object.keys(allData)) {
        for (const etf of allData[sid]) etfMap[etf.ticker] = etf;
    }
    // â‘¡ ëª¨ë“  ì„¹í„° ë°°ì—´ ì´ˆê¸°í™” í›„ ì›ë˜ ì„¹í„°ì— ì¬ë°°ì¹˜ + ë ˆê±°ì‹œ ìƒíƒœ ì›ë³µ
    for (const sid of Object.keys(allData)) allData[sid] = [];
    for (const [ticker, etf] of Object.entries(etfMap)) {
        const origSid = originalSectorState[ticker];
        if (!origSid || allData[origSid] === undefined) continue;
        const orig = originalLegacyState[ticker];
        if (orig) {
            etf.is_legacy      = orig.is_legacy;
            etf._user_override = false;
            etf.legacy_detail  = orig.legacy_detail.slice();
            etf.legacy_reasons = orig.legacy_reasons.slice();
            if (orig.r_anchor !== undefined) etf.r_anchor = orig.r_anchor;
        }
        delete etf._user_sector;
        delete etf._original_sector;
        allData[origSid].push(etf);
    }
    // â‘¢ ë ˆê±°ì‹œ ì˜¤ë²„ë¼ì´ë“œ ì ìš©
    for (const [ticker, o] of Object.entries(ov)) {
        if (!('is_legacy' in o)) continue;
        const found = findETFAnywhere(ticker);
        if (!found) continue;
        found.etf.is_legacy      = o.is_legacy;
        found.etf._user_override = true;
        found.etf.legacy_detail  = o.is_legacy ? ['ì‚¬ìš©ì ì§ì ‘ ì§€ì •'] : [];
        found.etf.legacy_reasons = o.is_legacy ? ['user_override'] : [];
    }
    // â‘£ ì„¹í„° ì´ë™ ì˜¤ë²„ë¼ì´ë“œ ì ìš©
    for (const [ticker, o] of Object.entries(ov)) {
        if (!o.sector || o.sector === originalSectorState[ticker]) continue;
        const origSid = originalSectorState[ticker];
        const newSid  = o.sector;
        if (allData[newSid] === undefined) continue;
        const idx = origSid && allData[origSid] ? allData[origSid].findIndex(e => e.ticker === ticker) : -1;
        if (idx === -1) continue;
        const [etf] = allData[origSid].splice(idx, 1);
        etf._user_sector    = newSid;
        etf._original_sector = origSid;
        allData[newSid].push(etf);
    }
    // â‘¤ r_anchor ì˜¤ë²„ë¼ì´ë“œ ì ìš©
    for (const [ticker, o] of Object.entries(ov)) {
        if (o.r_anchor === undefined) continue;
        const found = findETFAnywhere(ticker);
        if (!found) continue;
        found.etf.r_anchor = o.r_anchor;
    }
}

function pushUndo() {
    undoHistory.push(JSON.stringify(getUserOverrides()));
    if (undoHistory.length > MAX_UNDO_STEPS) undoHistory.shift();
    updateUndoBtn();
}

function updateUndoBtn() {
    const n = undoHistory.length;
    const $b = $('#btn-undo');
    $b.prop('disabled', n === 0);
    $b.text(n > 0 ? 'â†© ì‹¤í–‰ì·¨ì†Œ (' + n + ')' : 'â†© ì‹¤í–‰ì·¨ì†Œ');
}

function undoLegacyAction() {
    if (!undoHistory.length) return;
    const prevOv = JSON.parse(undoHistory.pop());
    saveUserOverrides(prevOv);
    applyOverridesToData(prevOv);
    recalcSectorMeta();
    renderSectorTabs();
    renderSummary();
    if (typeof table !== 'undefined') loadSector(state.activeSector);
    updateUndoBtn();
}

function resetAllOverrides() {
    if (!confirm(I18n.t('toast.reset.confirm'))) return;
    undoHistory = [];
    saveUserOverrides({});
    applyOverridesToData({});
    recalcSectorMeta();
    renderSectorTabs();
    renderSummary();
    if (typeof table !== 'undefined') loadSector(state.activeSector);
    updateUndoBtn();
}

function renderSectorTabs() {
    let sectors = [];
    if (state.activeAC === 'ALL') {
        sectors = Object.keys(sectorDefs).sort();
    } else {
        sectors = (acSectors[state.activeAC] || []).sort();
    }
    let allActive = state.activeSector === 'ALL' ? ' active' : '';
    let totalCount  = sectors.reduce((s, sid) => s + ((sectorMeta[sid]||{}).count||0), 0);
    let totalActiveN = sectors.reduce((s, sid) => s + ((sectorMeta[sid]||{}).active||0), 0);
    let html = '<button class="sec-tab' + allActive + '" data-sector="ALL">ì „ì²´<span class="sec-count">' + totalActiveN + '/' + totalCount + '</span></button>';

    let renderedSS = new Set();
    for (let sid of sectors) {
        let sd = sectorDefs[sid];
        let meta = sectorMeta[sid];
        if (!meta || meta.count === 0) continue;

        let ssId = sd.super_sector;
        if (ssId) {
            if (renderedSS.has(ssId)) continue;  // ì´ë¯¸ ìŠˆí¼ì„¹í„° íƒ­ ì¶”ê°€ë¨
            renderedSS.add(ssId);
            let ss = superSectorDefs[ssId];
            let ssMeta = getSuperSectorMeta(ssId);
            let ssIsActive = state.expandedSuperSector === ssId;
            let isActiveSS = (state.activeSector === 'SS_' + ssId) ? ' active' : '';
            let arrow = ssIsActive ? ' â–¾' : ' â–¸';
            html += '<button class="sec-tab super-sec-tab' + isActiveSS + '" data-supersec="' + ssId + '">';
            html += ss.icon + ' ' + sName(ss);
            html += '<span class="sec-count">' + ssMeta.active + '/' + ssMeta.count + '</span>';
            html += '<span class="expand-arrow">' + arrow + '</span></button>';
        } else {
            let isActive = state.activeSector === sid ? ' active' : '';
            html += '<button class="sec-tab' + isActive + '" data-sector="' + sid + '">';
            html += sd.icon + ' ' + sName(sd);
            html += '<span class="sec-count">' + (meta.active||0) + '/' + meta.count + '</span></button>';
        }
    }
    $('#secTabs').html(html);
    renderSubSecTabs();
}

function renderSubSecTabs() {
    let ssId = state.expandedSuperSector;
    if (!ssId) { $('#subSecTabs').hide(); return; }
    let ss = superSectorDefs[ssId];
    let html = '';
    for (let sid of ss.sub_sectors) {
        let sd = sectorDefs[sid];
        let meta = sectorMeta[sid];
        if (!meta || meta.count === 0) continue;
        let isActive = state.activeSector === sid ? ' active' : '';
        html += '<button class="sec-tab sub-sec-tab' + isActive + '" data-sector="' + sid + '">';
        html += sd.icon + ' ' + sName(sd);
        html += '<span class="sec-count">' + (meta.active||0) + '/' + meta.count + '</span></button>';
    }
    $('#subSecTabs').html(html).show();
}

function renderSummary() {
    let html = '';
    let sec = state.activeSector;
    if (sec === 'ALL') {
        let metas = Object.values(sectorMeta);
        let totalCount  = metas.reduce((s,m) => s+(m.count||0), 0);
        let totalActive = metas.reduce((s,m) => s+(m.active||0), 0);
        let totalLegacy = metas.reduce((s,m) => s+(m.legacy||0), 0);
        html += '<div class="stat-card"><div class="stat-value text-white">' + totalCount + '</div><div class="stat-label">ETFs</div></div>';
        html += '<div class="stat-card"><div class="stat-value text-green-400">' + totalActive + '</div><div class="stat-label">Active</div></div>';
        html += '<div class="stat-card"><div class="stat-value text-red-400">' + totalLegacy + '</div><div class="stat-label">Legacy</div></div>';
    } else if (sec && sec.startsWith('SS_')) {
        let ssId = sec.slice(3);
        let ssMeta = getSuperSectorMeta(ssId);
        let ss = superSectorDefs[ssId] || {};
        html += '<div class="stat-card"><div class="stat-value text-white">' + ssMeta.count + '</div><div class="stat-label">ETFs</div></div>';
        html += '<div class="stat-card"><div class="stat-value text-green-400">' + ssMeta.active + '</div><div class="stat-label">Active</div></div>';
        html += '<div class="stat-card"><div class="stat-value text-red-400">' + ssMeta.legacy + '</div><div class="stat-label">Legacy</div></div>';
        html += '<div class="stat-card" style="min-width:120px"><div class="stat-value text-yellow-300 text-sm">' + (ss.anchor||'â€”') + '</div><div class="stat-label">Anchor</div></div>';
    } else {
        let meta = sectorMeta[sec] || {};
        let sd = sectorDefs[sec] || {};
        html += '<div class="stat-card"><div class="stat-value text-white">' + (meta.count||0) + '</div><div class="stat-label">ETFs</div></div>';
        html += '<div class="stat-card"><div class="stat-value text-green-400">' + (meta.active||0) + '</div><div class="stat-label">Active</div></div>';
        html += '<div class="stat-card"><div class="stat-value text-red-400">' + (meta.legacy||0) + '</div><div class="stat-label">Legacy</div></div>';
        html += '<div class="stat-card"><div class="stat-value text-blue-300">' + (meta.avg_cagr > 0 ? '+' : '') + (meta.avg_cagr||0).toFixed(1) + '%</div><div class="stat-label">Avg CAGR</div></div>';
        html += '<div class="stat-card"><div class="stat-value text-gray-300">' + (meta.avg_vol||0).toFixed(1) + '%</div><div class="stat-label">Avg Vol</div></div>';
        html += '<div class="stat-card"><div class="stat-value text-purple-400">' + (meta.avg_sortino||0).toFixed(2) + '</div><div class="stat-label">Avg Sortino</div></div>';
        html += '<div class="stat-card" style="min-width:120px"><div class="stat-value text-yellow-300 text-sm">' + (sd.anchor||'â€”') + '</div><div class="stat-label">Anchor</div></div>';
    }
    $('#summaryCards').html(html);
}

function loadSector(sectorId) {
    state.activeSector = sectorId;
    // ìŠˆí¼ì„¹í„° ì†Œì† ì„¹í„°ë¥¼ ì§ì ‘ í´ë¦­í•˜ë©´ í•´ë‹¹ ìŠˆí¼ì„¹í„°ë¥¼ ìë™ í™•ì¥
    if (sectorId && !sectorId.startsWith('SS_') && sectorId !== 'ALL') {
        let sd = sectorDefs[sectorId];
        if (sd && sd.super_sector) {
            state.expandedSuperSector = sd.super_sector;
        } else {
            state.expandedSuperSector = null;
        }
    }
    renderSectorTabs();
    renderSummary();
    let data;
    if (sectorId === 'ALL') {
        data = Object.values(allData).flat();
    } else if (sectorId && sectorId.startsWith('SS_')) {
        let ssId = sectorId.slice(3);
        let ss = superSectorDefs[ssId];
        data = ss ? ss.sub_sectors.flatMap(sid => allData[sid] || []) : [];
    } else {
        data = allData[sectorId] || [];
    }
    table.clear().rows.add(data).draw();
}

function loadSuperSector(ssId) {
    state.activeSector = 'SS_' + ssId;
    state.expandedSuperSector = ssId;
    renderSectorTabs();
    renderSummary();
    let ss = superSectorDefs[ssId];
    let data = ss ? ss.sub_sectors.flatMap(sid => allData[sid] || []) : [];
    table.clear().rows.add(data).draw();
}

// â”€â”€ í† ìŠ¤íŠ¸ ì•Œë¦¼ (ì „ì—­) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _toastTimer = null;
function showToast(msg, durationMs) {
    let el = document.getElementById('r-toast');
    if (!el) {
        el = document.createElement('div');
        el.id = 'r-toast';
        el.style.cssText = 'position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:#1e293b;color:#e2e8f0;padding:9px 18px;border-radius:10px;font-size:0.85rem;border:1px solid rgba(255,255,255,0.12);box-shadow:0 4px 20px rgba(0,0,0,0.5);z-index:9999;pointer-events:none;transition:opacity 0.3s;opacity:0;white-space:nowrap;';
        document.body.appendChild(el);
    }
    if (_toastTimer) clearTimeout(_toastTimer);
    el.textContent = msg;
    el.style.opacity = '1';
    _toastTimer = setTimeout(function() { el.style.opacity = '0'; }, durationMs || 3000);
}

// â”€â”€ ë‹¤ê¸°ê¸° ë™ê¸°í™” (Vercel Blob, /api/sync) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _syncDirty = false;
let _saveHideTimer = null;

function setSyncStatus(s) {
    const dot = document.getElementById('sync-dot');
    const lbl = document.getElementById('sync-label');
    if (!dot || !lbl) return;
    dot.className = 'sync-dot' + (s && s !== 'off' ? ' ' + s : '');
    const map = { ok: 'sync.ok', err: 'sync.err', busy: 'sync.busy' };
    lbl.textContent = map[s] ? I18n.t(map[s]) : I18n.t('btn.sync');
}

function setSaveFloat(state) {
    const wrap = document.getElementById('save-float');
    const btn  = document.getElementById('save-float-btn');
    const icon = document.getElementById('save-float-icon');
    const lbl  = document.getElementById('save-float-label');
    if (!wrap) return;
    clearTimeout(_saveHideTimer);
    const map = {
        hidden:  null,
        dirty:   { icon: 'â˜', label: I18n.t('save.dirty'),  cls: '' },
        saving:  { icon: 'â€¦', label: I18n.t('save.saving'), cls: 'state-saving' },
        saved:   { icon: 'âœ“', label: I18n.t('save.saved'),  cls: 'state-saved' },
        error:   { icon: 'âœ•', label: I18n.t('save.error'),  cls: 'state-error' },
    };
    const s = map[state];
    if (!s) { wrap.classList.remove('visible'); return; }
    wrap.classList.add('visible');
    btn.className = s.cls;
    btn.disabled = (state === 'saving');
    icon.textContent = s.icon;
    lbl.textContent  = s.label;
    if (state === 'saved') {
        _saveHideTimer = setTimeout(() => { if (!_syncDirty) setSaveFloat('hidden'); }, 2500);
    }
}

async function fetchRemoteOverrides() {
    try {
        const r = await fetch('/api/sync?t=' + Date.now());
        if (!r.ok) return null;
        const d = await r.json();
        return d.content;  // { _meta: {ts}, ...overrides }
    } catch(e) { return null; }
}

async function pushRemoteOverrides(ov, manual) {
    setSyncStatus('busy');
    if (manual) setSaveFloat('saving');
    try {
        const r = await fetch('/api/sync', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ overrides: ov }),
        });
        if (r.ok) {
            _syncDirty = false;
            setSyncStatus('ok');
            setSaveFloat('saved');
        } else {
            setSyncStatus('err');
            // ìë™ ì €ì¥ ì‹¤íŒ¨ â†’ dirty ìœ ì§€(ì¡°ìš©íˆ), ìˆ˜ë™ ì €ì¥ ì‹¤íŒ¨ â†’ ì—ëŸ¬ í‘œì‹œ
            setSaveFloat(manual ? 'error' : 'dirty');
        }
    } catch(e) {
        setSyncStatus('err');
        setSaveFloat(manual ? 'error' : 'dirty');
    }
}

async function manualSyncSave() {
    if (document.getElementById('save-float-btn')?.disabled) return;
    await pushRemoteOverrides(getUserOverrides(), true);
}

// 30ì´ˆë§ˆë‹¤ ì›ê²© ë³€ê²½ì‚¬í•­ ìë™ ë°˜ì˜
async function pollRemoteSync() {
    const remoteOv = await fetchRemoteOverrides();
    if (!remoteOv || !remoteOv._meta) return;
    const localTs = parseInt(localStorage.getItem('corryu_overrides_ts') || '0');
    if (remoteOv._meta.ts > localTs) {
        const { _meta, ...cleanOv } = remoteOv;
        localStorage.setItem(USER_OVERRIDES_KEY, JSON.stringify(cleanOv));
        localStorage.setItem('corryu_overrides_ts', String(remoteOv._meta.ts));
        applyOverridesToData(cleanOv);
        recalcSectorMeta();
        renderSectorTabs();
        renderSummary();
        if (typeof table !== 'undefined') loadSector(state.activeSector);
        setSyncStatus('ok');
        showToast(I18n.t('toast.sync.applied'), 3000);
    }
}

function initDashboard() {
    renderACTabs();
    renderSectorTabs();
    renderSummary();

    table = $('#masterTable').DataTable({
        data: Object.values(allData).flat(),
        pageLength: 50,
        deferRender: true,
        scrollX: true,
        lengthMenu: [[25, 50, 100, 200, -1], [25, 50, 100, 200, "All"]],
        order: [],
        columns: [
            {
                data: null, orderable: false, searchable: false,
                className: 'text-center',
                render: function(d, type, row) {
                    if (type !== 'display') return '';
                    let checked = selectedTickers.has(row.ticker) ? ' checked' : '';
                    return '<input type="checkbox" class="row-cb"' + checked + ' data-ticker="' + row.ticker + '">';
                }
            },
            {
                data: null, orderable: false, searchable: false,
                className: 'text-right text-gray-600',
                render: function(d, type, row, meta) {
                    if (type !== 'display') return meta.row + meta.settings._iDisplayStart;
                    return '<span style="font-size:0.75rem">' + (meta.row + meta.settings._iDisplayStart + 1) + '</span>';
                }
            },
            {
                data: 'ticker', className: 'text-left font-semibold',
                render: function(d, type, row) {
                    if (type !== 'display') return d;
                    let isMine = myPortfolio.includes(d);
                    let cls = isMine ? 'text-yellow-400 text-base' : 'text-blue-300';
                    let h = '<span class="'+cls+'">'+d+'</span>';
                    if (row.short_history) h += '<span class="badge-short" title="ìƒì¥ 3ë…„ ë¯¸ë§Œ">ì§§ì€ì—°í˜</span>';
                    return h;
                }
            },
            {
                data: 'name', className: 'text-left text-xs text-gray-400',
                render: function(d, type, row) {
                    if (type !== 'display') return d;
                    let h = '<div class="leading-tight">'+d+'</div>';
                    if (myPortfolio.includes(row.ticker)) {
                        h += '<div class="mt-1"><span class="mine-badge">MY</span></div>';
                    }
                    return h;
                }
            },
            { data: 'rank', render: function(d,t){ return t==='display'?(d===9999?'-':d):d; } },
            { data: 'aum', render: function(d,t){ return t==='display'?formatMCap(d):d; } },
            { data: 'r_anchor', render: function(d,t) {
                if(t!=='display') return d;
                let c = d >= 0.70 ? 'text-pink-400 font-bold' : (d <= -0.3 ? 'text-green-400 font-bold' : 'text-gray-400');
                return '<span class="'+c+'">'+d.toFixed(2)+'</span>';
            } },
            { data: 'smh_corr', defaultContent: null, render: function(d,t) {
                if(t!=='display') return (d===null||d===undefined) ? -9999 : d;
                if(d===null||d===undefined) return '<span class="text-gray-700">â€“</span>';
                let c = d >= 0.70 ? 'text-violet-400 font-bold' : (d <= -0.3 ? 'text-green-400 font-bold' : 'text-gray-400');
                return '<span class="'+c+'">'+d.toFixed(2)+'</span>';
            } },
            { data: 'z_score', render: function(d,t,row) {
                if(row.short_history && t==='display') return '<span class="text-gray-600">-</span>';
                if(t!=='display') return row.short_history ? -999999 : d;
                let c = d <= -1.5 ? 'value-down font-bold' : (d >= 2.0 ? 'value-up font-bold' : 'text-gray-500');
                return '<span class="'+c+'">'+d.toFixed(2)+'</span>';
            } },
            { data: 'ma200_pct', render: function(d,t,row) {
                if(row.short_history && t==='display') return '<span class="text-gray-600">-</span>';
                if(t!=='display') return row.short_history ? -999999 : d;
                let c = d <= -10 ? 'value-down font-bold' : (d >= 15 ? 'value-up font-bold' : 'text-gray-500');
                return '<span class="'+c+'">'+(d>0?'+':'')+d.toFixed(1)+'%</span>';
            } },
            { data: 'rsi', defaultContent: null, render: function(d,t,row) {
                if(d === null || d === undefined) return t==='display' ? '<span class="text-gray-600">-</span>' : -1;
                if(t!=='display') return d;
                let c = d <= 30 ? 'value-down font-bold' : (d >= 70 ? 'value-up font-bold' : 'text-gray-500');
                return '<span class="'+c+'">'+d.toFixed(0)+'</span>';
            } },
            { data: 'range_52w', defaultContent: null, render: function(d,t,row) {
                if(d === null || d === undefined) return t==='display' ? '<span class="text-gray-600">-</span>' : -1;
                if(t!=='display') return d;
                let c = d <= 20 ? 'value-down font-bold' : (d >= 80 ? 'value-up font-bold' : 'text-gray-500');
                return '<span class="'+c+'">'+d.toFixed(0)+'%</span>';
            } },
            { data: 'mdd_52w', render: function(d,t,row) {
                if(row.short_history && t==='display') return '<span class="text-gray-600">-</span>';
                if(t!=='display') return row.short_history ? -999999 : d;
                let c = d <= -20 ? 'value-down font-bold' : 'text-gray-500';
                return '<span class="'+c+'">'+d.toFixed(1)+'%</span>';
            } },
            { data: 'cagr', render: function(d,t,row) {
                if(row.short_history && t==='display') return '<span class="text-gray-600">-</span>';
                if(t!=='display') return row.short_history ? -999999 : (d||0);
                return '<span class="text-gray-300 font-semibold">'+(d>0?'+':'')+d.toFixed(1)+'%</span>';
            } },
            { data: 'vol', render: function(d,t,row) {
                if(row.short_history && t==='display') return '<span class="text-gray-600">-</span>';
                if(t!=='display') return row.short_history ? -999999 : (d||0);
                return '<span class="text-gray-500">'+d.toFixed(1)+'%</span>';
            } },
            { data: 'sortino', render: function(d,t,row) {
                if(row.short_history && t==='display') return '<span class="text-gray-600">-</span>';
                if(t!=='display') return row.short_history ? -999999 : (d===null?-999999:d);
                let c = d > 1.2 ? 'text-purple-400 font-bold' : 'text-gray-500';
                return '<span class="'+c+'">'+d.toFixed(2)+'</span>';
            } },
            { data: 'inception', className: 'text-xs text-gray-600', render: function(d, t) {
                if(t !== 'display') return d || '';
                if(!d || d==='1900-01-01') return '-';
                return d.substring(2);
            } },
            { data: 'is_legacy', render: function(d,t,row) {
                if(t!=='display') return d ? 1 : 0;
                let out = '';
                if(!d) {
                    out = '<span class="badge-active">Active</span>';
                } else {
                    let detail = (row.legacy_detail||[]).join(' / ');
                    let badge = row._user_override
                        ? '<span class="badge-user-legacy">User Legacy</span>'
                        : '<span class="badge-legacy">Legacy</span>';
                    out = badge + (detail ? '<div class="text-xs text-orange-400 mt-0.5 opacity-80">'+detail+'</div>' : '');
                }
                if(row._user_sector) {
                    let sd = sectorDefs[row._user_sector] || {};
                    out += '<div style="margin-top:2px"><span class="badge-user-sector">'+(sd.icon||'')+'&nbsp;'+(sName(sd)||row._user_sector)+'</span></div>';
                }
                return out;
            } }
        ],
        rowCallback: function(row, data) {
            if (data.is_legacy) $(row).addClass('row-legacy');
            else $(row).removeClass('row-legacy');
            if (selectedTickers.has(data.ticker)) $(row).addClass('row-selected');
            else $(row).removeClass('row-selected');
        }
    });

    // Custom filter
    $.fn.dataTable.ext.search.push(function(settings, searchData, dataIndex) {
        let row = settings.aoData[dataIndex]._aData;
        if (state.hideLegacy && row.is_legacy) return false;
        if (state.hideShort && row.short_history) return false;
        if (state.minAum > 0 && row.aum < state.minAum * 1e6) return false;
        if (state.minSortino > -999 && !row.short_history) {
            if (row.sortino < state.minSortino) return false;
        }
        return true;
    });

    // Event: Asset Class tab click
    $(document).on('click', '.ac-tab', function() {
        state.activeAC = $(this).data('ac');
        state.expandedSuperSector = null;
        renderACTabs();
        if (state.activeAC === 'ALL') {
            loadSector('ALL');
        } else {
            let sectors = (acSectors[state.activeAC] || []).sort();
            let firstWithData = sectors.find(s => sectorMeta[s] && sectorMeta[s].count > 0);
            if (firstWithData) loadSector(firstWithData);
            else renderSectorTabs();
        }
    });

    // Event: Super-sector tab click (ìŠˆí¼ì„¹í„° íƒ­ â†’ ì„œë¸Œíƒ­ í† ê¸€)
    $(document).on('click', '.super-sec-tab', function() {
        let ssId = $(this).data('supersec');
        if (state.expandedSuperSector === ssId) {
            // ì´ë¯¸ ì—´ë ¤ ìˆìœ¼ë©´ ë‹«ê³  ì „ì²´ ë³´ê¸°
            state.expandedSuperSector = null;
            loadSector('ALL');
        } else {
            loadSuperSector(ssId);
        }
    });

    // Event: Sector tab click (ì„œë¸Œì„¹í„° íƒ­ í¬í•¨)
    $(document).on('click', '.sec-tab:not(.super-sec-tab)', function() {
        loadSector($(this).data('sector'));
    });

    // Event: Filters
    $('#filterLegacy').on('change', function() { state.hideLegacy = this.checked; table.draw(); });
    $('#filterShort').on('change', function() { state.hideShort = this.checked; table.draw(); });
    $('#filterAum').on('input', function() { state.minAum = parseFloat(this.value) || 0; table.draw(); });
    $('#filterSortino').on('input', function() {
        let v = parseFloat(this.value);
        state.minSortino = isNaN(v) ? -999 : v;
        table.draw();
    });

    // â”€â”€ ì²´í¬ë°•ìŠ¤ ì´ë²¤íŠ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function updateFAB() {
        let n = selectedTickers.size;
        $('#fab-label').text(I18n.t('fab.selected', { count: n }));
        n > 0 ? $('#fab').show() : $('#fab').hide();
        // ì „ì²´ì„ íƒ ì²´í¬ë°•ìŠ¤ ìƒíƒœ ë™ê¸°í™”
        let visibleTickers = [];
        table.rows({ filter: 'applied', page: 'current' }).every(function() {
            visibleTickers.push(this.data().ticker);
        });
        let allChecked = visibleTickers.length > 0 && visibleTickers.every(t => selectedTickers.has(t));
        $('#select-all-cb').prop('checked', allChecked);
    }

    // ê°œë³„ ì²´í¬ë°•ìŠ¤
    $('#masterTable').on('change', 'input.row-cb', function() {
        let ticker = $(this).data('ticker');
        if (this.checked) selectedTickers.add(ticker);
        else selectedTickers.delete(ticker);
        let row = table.row($(this).closest('tr'));
        if (this.checked) $(row.node()).addClass('row-selected');
        else $(row.node()).removeClass('row-selected');
        updateFAB();
    });

    // ì „ì²´ ì„ íƒ/í•´ì œ
    $('#select-all-cb').on('change', function() {
        let checked = this.checked;
        table.rows({ filter: 'applied', page: 'current' }).every(function() {
            let d = this.data();
            if (checked) selectedTickers.add(d.ticker);
            else selectedTickers.delete(d.ticker);
            if (checked) $(this.node()).addClass('row-selected');
            else $(this.node()).removeClass('row-selected');
        });
        $('input.row-cb').prop('checked', checked);
        updateFAB();
    });

    // í˜ì´ì§€/ì •ë ¬/í•„í„° ë³€ê²½ í›„ ì „ì²´ì„ íƒ ì²´í¬ë°•ìŠ¤ ìƒíƒœ ê°±ì‹ 
    table.on('draw', function() { updateFAB(); });

    // â”€â”€ FAB ì•¡ì…˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function applyLegacyAction(setLegacy) {
        if (selectedTickers.size === 0) return;
        pushUndo();
        let ov = getUserOverrides();
        selectedTickers.forEach(function(ticker) {
            // ì„¹í„° ì˜¤ë²„ë¼ì´ë“œê°€ ìˆìœ¼ë©´ ìœ ì§€í•œ ì±„ is_legacyë§Œ ì—…ë°ì´íŠ¸
            if (!ov[ticker]) ov[ticker] = {};
            ov[ticker].is_legacy = setLegacy;
            const found = findETFAnywhere(ticker);
            if (found) {
                found.etf.is_legacy      = setLegacy;
                found.etf._user_override = true;
                found.etf.legacy_detail  = setLegacy ? ['ì‚¬ìš©ì ì§ì ‘ ì§€ì •'] : [];
                found.etf.legacy_reasons = setLegacy ? ['user_override'] : [];
            }
        });
        saveUserOverrides(ov);
        recalcSectorMeta();
        renderSectorTabs();
        renderSummary();
        selectedTickers.clear();
        table.rows().invalidate('data').draw(false);
        $('#select-all-cb').prop('checked', false);
        updateFAB();
    }

    // â”€â”€ ì¹´í…Œê³ ë¦¬ ì´ë™ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function buildSectorModal() {
        // ì„ íƒëœ ETFë“¤ì˜ í˜„ì¬ ì„¹í„° ìˆ˜ì§‘ (ë‹¨ì¼ì´ë©´ í•˜ì´ë¼ì´íŠ¸)
        const curSectors = new Set();
        selectedTickers.forEach(function(tk) {
            const found = findETFAnywhere(tk);
            if (found) curSectors.add(found.sid);
        });
        $('#modal-sel-info').text(I18n.t('fab.move.prompt', { count: selectedTickers.size }));
        const ordered = Object.entries(acDefs).sort((a,b) => a[1].order - b[1].order);
        let html = '';
        for (const [ac, acDef] of ordered) {
            const sids = (acSectors[ac] || []).sort();
            if (!sids.length) continue;
            html += '<div class="smg">' + acDef.icon + ' ' + sName(acDef) + '</div>';
            html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:5px;margin-bottom:4px">';
            for (const sid of sids) {
                const sd = sectorDefs[sid];
                if (!sd) continue;
                const isCur = curSectors.size === 1 && curSectors.has(sid);
                html += '<button class="smb' + (isCur ? ' cur' : '') + '" data-sid="' + sid + '">';
                html += '<span style="font-size:1rem">' + (sd.icon||'') + '</span>';
                html += '<div><div style="font-weight:600;font-size:0.8rem">' + sName(sd) + '</div>';
                html += '<div style="font-size:0.68rem;color:#475569">' + (sd.name_en||'') + '</div></div>';
                html += '</button>';
            }
            html += '</div>';
        }
        $('#sector-modal-body').html(html);
    }

    function applySectorMove(newSectorId) {
        if (!newSectorId || selectedTickers.size === 0) return;
        const tickersToRecompute = [];
        pushUndo();
        let ov = getUserOverrides();
        selectedTickers.forEach(function(ticker) {
            const found = findETFAnywhere(ticker);
            if (!found) return;
            const { etf, sid: oldSid } = found;
            if (!ov[ticker]) ov[ticker] = {};
            if (oldSid === newSectorId) {
                // ì´ë¯¸ ì´ ì„¹í„° â†’ ì„¹í„° ì˜¤ë²„ë¼ì´ë“œ í•´ì œ
                delete ov[ticker].sector;
                delete ov[ticker].r_anchor;
                delete etf._user_sector;
                delete etf._original_sector;
                if (!Object.keys(ov[ticker]).length) delete ov[ticker];
                return;
            }
            tickersToRecompute.push(ticker);
            // allDataì—ì„œ ì´ë™
            allData[oldSid] = allData[oldSid].filter(e => e.ticker !== ticker);
            etf._user_sector     = newSectorId;
            etf._original_sector = originalSectorState[ticker];
            if (!allData[newSectorId]) allData[newSectorId] = [];
            allData[newSectorId].push(etf);
            // localStorage ì €ì¥ (ê¸°ì¡´ is_legacy ë³´ì¡´)
            ov[ticker].sector = newSectorId;
        });
        saveUserOverrides(ov);
        recalcSectorMeta();
        renderSectorTabs();
        renderSummary();
        selectedTickers.clear();
        $('#sector-modal').removeClass('show');
        loadSector(state.activeSector);
        updateFAB();
        if (tickersToRecompute.length) recomputeRanchorsAsync(tickersToRecompute, newSectorId);
    }

    // â”€â”€ ë¸Œë¼ìš°ì €-ì‚¬ì´ë“œ r_anchor ì¬ê³„ì‚° ìœ í‹¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function _sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

    function _pearson(xs, ys) {
        const n = xs.length;
        if (n < 2) return NaN;
        let mx = 0, my = 0;
        for (let i = 0; i < n; i++) { mx += xs[i]; my += ys[i]; }
        mx /= n; my /= n;
        let num = 0, dx2 = 0, dy2 = 0;
        for (let i = 0; i < n; i++) {
            const dx = xs[i] - mx, dy = ys[i] - my;
            num += dx * dy; dx2 += dx * dx; dy2 += dy * dy;
        }
        return (dx2 && dy2) ? num / Math.sqrt(dx2 * dy2) : NaN;
    }

    function _pairwiseReturns(pA, pB) {
        const dates = Object.keys(pA).filter(d => d in pB).sort();
        const rA = [], rB = [];
        for (let i = 1; i < dates.length; i++) {
            const a0 = pA[dates[i-1]], a1 = pA[dates[i]];
            const b0 = pB[dates[i-1]], b1 = pB[dates[i]];
            if (a0 && a1 && b0 && b1) {
                rA.push((a1 - a0) / a0);
                rB.push((b1 - b0) / b0);
            }
        }
        return [rA, rB];
    }

    function _calcCorr(pA, pB) {
        const [rA, rB] = _pairwiseReturns(pA, pB);
        if (rA.length < 24) return null;
        const c = _pearson(rA, rB);
        return isFinite(c) ? Math.round(c * 10000) / 10000 : null;
    }

    function _makeYfUrls(ticker) {
        const tk = encodeURIComponent(ticker);
        const yf1 = 'https://query1.finance.yahoo.com/v8/finance/chart/' + tk + '?range=max&interval=1mo&includeAdjustedClose=true';
        return [
            '/api/yf?ticker=' + tk + '&range=max&interval=1mo',
            yf1,
            'https://query2.finance.yahoo.com/v8/finance/chart/' + tk + '?range=max&interval=1mo&includeAdjustedClose=true',
            'https://corsproxy.io/?' + encodeURIComponent(yf1),
        ];
    }

    function _parseYfMonthly(data) {
        const result = data && data.chart && data.chart.result && data.chart.result[0];
        if (!result) return null;
        const ts  = result.timestamp;
        const adj = (result.indicators && result.indicators.adjclose && result.indicators.adjclose[0] && result.indicators.adjclose[0].adjclose)
                 || (result.indicators && result.indicators.quote && result.indicators.quote[0] && result.indicators.quote[0].close);
        if (!ts || !adj) return null;
        const prices = {};
        for (let i = 0; i < ts.length; i++) {
            if (adj[i] != null) {
                const d = new Date(ts[i] * 1000);
                prices[d.getUTCFullYear() + '-' + String(d.getUTCMonth() + 1).padStart(2, '0')] = adj[i];
            }
        }
        return Object.keys(prices).length >= 3 ? prices : null;
    }

    async function _fetchYfMonthly(ticker) {
        for (const url of _makeYfUrls(ticker)) {
            for (let attempt = 0; attempt < 2; attempt++) {
                try {
                    const r = await fetch(url);
                    if (r.status === 429) { await _sleep(3000 * (attempt + 1)); continue; }
                    if (!r.ok) break;
                    const prices = _parseYfMonthly(await r.json());
                    if (prices) return prices;
                    break;
                } catch(e) { await _sleep(500); }
            }
        }
        return null;
    }

    async function recomputeRanchorsAsync(tickers, newSectorId) {
        const anchor = (sectorDefs[newSectorId] || {}).anchor;
        if (!anchor || anchor === 'â€”') return;
        const tickerList = Array.isArray(tickers) ? tickers : Array.from(tickers);
        if (!tickerList.length) return;
        showToast('r_anchor ì¬ê³„ì‚° ì¤‘â€¦ ì•µì»¤: ' + anchor + ' / ' + tickerList.length + 'ì¢…ëª©', 60000);
        const anchorPrices = await _fetchYfMonthly(anchor);
        if (!anchorPrices) {
            showToast('ì•µì»¤(' + anchor + ') ê°€ê²© ì¡°íšŒ ì‹¤íŒ¨', 4000);
            return;
        }
        let ok = 0;
        const ov = getUserOverrides();
        for (const ticker of tickerList) {
            const found = findETFAnywhere(ticker);
            if (!found) continue;
            const prices = await _fetchYfMonthly(ticker);
            if (!prices) continue;
            const corr = _calcCorr(anchorPrices, prices);
            if (corr === null) continue;
            found.etf.r_anchor = corr;
            if (!ov[ticker]) ov[ticker] = {};
            ov[ticker].r_anchor = corr;
            ok++;
            await _sleep(150);
        }
        saveUserOverrides(ov);
        if (ok > 0 && typeof table !== 'undefined') table.rows().invalidate('data').draw(false);
        showToast('r_anchor ì¬ê³„ì‚° ì™„ë£Œ (' + ok + '/' + tickerList.length + 'ì¢…ëª©)', 4000);
    }

    $('#fab-btn-legacy').on('click', function() { applyLegacyAction(true); });
    $('#fab-btn-unlegacy').on('click', function() { applyLegacyAction(false); });
    $('#fab-btn-move').on('click', function() {
        if (selectedTickers.size === 0) return;
        buildSectorModal();
        $('#sector-modal').addClass('show');
    });
    $('#sector-modal-close').on('click', function() { $('#sector-modal').removeClass('show'); });
    $('#sector-modal').on('click', function(e) { if (e.target === this) $(this).removeClass('show'); });
    $(document).on('click', '#sector-modal-body .smb', function() {
        applySectorMove($(this).data('sid'));
    });
    $('#fab-btn-clear').on('click', function() {
        selectedTickers.clear();
        $('input.row-cb').prop('checked', false);
        table.rows().every(function() { $(this.node()).removeClass('row-selected'); });
        updateFAB();
    });

    // â”€â”€ ì‹¤í–‰ì·¨ì†Œ / ì´ˆê¸°í™” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    $('#btn-undo').on('click', undoLegacyAction);
    $('#btn-reset').on('click', resetAllOverrides);
    $(document).on('keydown', function(e) {
        if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) {
            e.preventDefault();
            undoLegacyAction();
        }
    });
    // â”€â”€ ë™ê¸°í™” ë²„íŠ¼: í´ë¦­ ì‹œ ì›ê²© â†’ ë¡œì»¬ ì¦‰ì‹œ ì ìš© â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    $('#sync-status').on('click', async function() {
        setSyncStatus('busy');
        const remoteOv = await fetchRemoteOverrides();
        if (!remoteOv) { setSyncStatus('err'); showToast(I18n.t('toast.sync.noconnect'), 3000); return; }
        const localTs = parseInt(localStorage.getItem('corryu_overrides_ts') || '0');
        const remoteTs = remoteOv._meta ? remoteOv._meta.ts : 0;
        if (remoteTs > localTs) {
            const { _meta, ...cleanOv } = remoteOv;
            localStorage.setItem(USER_OVERRIDES_KEY, JSON.stringify(cleanOv));
            localStorage.setItem('corryu_overrides_ts', String(remoteTs));
            applyOverridesToData(cleanOv);
            recalcSectorMeta();
            renderSectorTabs();
            renderSummary();
            if (typeof table !== 'undefined') loadSector(state.activeSector);
            setSyncStatus('ok');
            showToast(I18n.t('toast.sync.latest', { count: Object.keys(cleanOv).length }), 3000);
        } else if (!_syncDirty) {
            setSyncStatus('ok');
            showToast(I18n.t('toast.sync.uptodate'), 2000);
        } else {
            // ë¡œì»¬ì´ ë” ìµœì‹  â†’ ì—…ë¡œë“œ
            pushRemoteOverrides(getUserOverrides());
        }
    });

    updateUndoBtn();
}

$(document).ready(function() {
    fetch('etf_data.json')
        .then(function(r) { return r.json(); })
        .then(async function(d) {
            sectorMeta = d.sectorMeta;
            allData = d.allData;
            snapshotOriginalLegacy(); // ë¹Œë“œ ê¸°ë³¸ê°’ ìŠ¤ëƒ…ìƒ· (undo ê¸°ì¤€ì )
            // ë‹¤ê¸°ê¸° ë™ê¸°í™”: ì›ê²© ì˜¤ë²„ë¼ì´ë“œ ë¡œë“œ ì‹œë„ (ì„œë²„ì‚¬ì´ë“œ PAT)
            let ov = getUserOverrides();
            const localTs = parseInt(localStorage.getItem('corryu_overrides_ts') || '0');
            setSyncStatus('busy');
            const remoteOv = await fetchRemoteOverrides();
            if (remoteOv && remoteOv._meta) {
                if (remoteOv._meta.ts > localTs) {
                    // ì›ê²©ì´ ë” ìµœì‹  â†’ ë¡œì»¬ì— ì ìš©
                    const { _meta, ...cleanOv } = remoteOv;
                    ov = cleanOv;
                    localStorage.setItem(USER_OVERRIDES_KEY, JSON.stringify(ov));
                    localStorage.setItem('corryu_overrides_ts', String(remoteOv._meta.ts));
                    setSyncStatus('ok');
                    showToast(I18n.t('toast.sync.loaded', { count: Object.keys(ov).length }), 3500);
                } else if (localTs > remoteOv._meta.ts && Object.keys(ov).length) {
                    // ë¡œì»¬ì´ ë” ìµœì‹  â†’ ì›ê²©ì— í‘¸ì‹œ
                    pushRemoteOverrides(ov);
                } else {
                    setSyncStatus('ok');
                }
            } else if (!remoteOv && Object.keys(ov).length) {
                // ì›ê²© íŒŒì¼ ì—†ìŒ + ë¡œì»¬ ë°ì´í„° ìˆìŒ â†’ ì›ê²©ì— ì—…ë¡œë“œ
                pushRemoteOverrides(ov);
            } else {
                setSyncStatus('ok');
            }
            if (Object.keys(ov).length) applyOverridesToData(ov);
            applySmhCorr();           // localStorage SMH ìƒê´€ê³„ìˆ˜ ì ìš©
            recalcSectorMeta();       // ì˜¤ë²„ë¼ì´ë“œ ë°˜ì˜í•´ ì¹´ìš´íŠ¸ ê°±ì‹ 
            await I18n.init();        // i18n ì´ˆê¸°í™” (ì €ì¥ëœ ì–¸ì–´ ë¡œë“œ)
            initDashboard();
            setInterval(pollRemoteSync, 30000); // 30ì´ˆë§ˆë‹¤ ì›ê²© ë³€ê²½ì‚¬í•­ ìë™ ì²´í¬

            // ì–¸ì–´ ì „í™˜ ì‹œ íƒ­Â·ì„¹í„°ëª… ì¦‰ì‹œ ì¬ë Œë”ë§
            document.addEventListener('i18n:ready', function() {
                renderACTabs();
                renderSectorTabs();
                renderSummary();
                updateFAB();
                if (typeof table !== 'undefined') table.rows().invalidate('data').draw(false);
            });
        });
});
</script>
</body>
</html>