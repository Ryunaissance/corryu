<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ETF 비교 — CORRYU</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script src="/supabase-client.js"></script>
<script src="/i18n.js"></script>
<script src="https://unpkg.com/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js"></script>
<style>
:root {
  --bg-primary: #0a0d14; --bg-card: rgba(18,22,36,0.92);
  --border: rgba(255,255,255,0.07); --text-primary: #e2e8f0;
  --text-muted: #64748b; --accent: #3b82f6;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body { background: var(--bg-primary); color: var(--text-primary); font-family: 'Inter', sans-serif; min-height: 100vh; -webkit-font-smoothing: antialiased; }
.glass { background: var(--bg-card); backdrop-filter: blur(16px); border: 1px solid var(--border); border-radius: 14px; }
.gradient-line { position: fixed; top: 0; left: 0; right: 0; height: 3px; z-index: 200; background: linear-gradient(90deg,#3b82f6,#8b5cf6,#ec4899,#f59e0b); }
.text-gradient { background: linear-gradient(135deg,#60a5fa,#a78bfa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
nav { position: fixed; top: 3px; left: 0; right: 0; z-index: 100; background: rgba(10,13,20,0.9); backdrop-filter: blur(20px); border-bottom: 1px solid var(--border); height: 56px; display: flex; align-items: center; }
.nav-inner { max-width: 1320px; margin: 0 auto; padding: 0 24px; width: 100%; display: flex; align-items: center; gap: 14px; }
.nav-back { display: flex; align-items: center; gap: 6px; color: var(--text-muted); font-size: 0.82rem; font-weight: 600; text-decoration: none; transition: color 0.15s; }
.nav-back:hover { color: #60a5fa; }
.main-wrap { max-width: 1320px; margin: 0 auto; padding: 76px 20px 48px; }

/* ── Ticker 선택 영역 ── */
.selector-card { padding: 20px 24px; margin-bottom: 16px; }
.selector-title { font-size: 1.4rem; font-weight: 900; letter-spacing: -0.03em; margin-bottom: 16px; }
.selector-row { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
.ticker-chip {
  display: inline-flex; align-items: center; gap: 6px;
  padding: 6px 12px; border-radius: 8px; font-size: 0.88rem; font-weight: 800;
  border: 1px solid; cursor: default;
}
.chip-0 { background: rgba(59,130,246,0.12); color: #60a5fa; border-color: rgba(59,130,246,0.3); }
.chip-1 { background: rgba(167,139,250,0.12); color: #a78bfa; border-color: rgba(167,139,250,0.3); }
.chip-2 { background: rgba(245,158,11,0.12); color: #f59e0b; border-color: rgba(245,158,11,0.3); }
.chip-close { background: none; border: none; cursor: pointer; font-size: 0.9rem; opacity: 0.6; padding: 0; line-height: 1; font-family: inherit; transition: opacity 0.15s; }
.chip-close:hover { opacity: 1; }
.add-input-wrap { display: flex; gap: 0; background: rgba(255,255,255,0.04); border: 1px solid var(--border); border-radius: 8px; overflow: hidden; }
.add-input { background: none; border: none; outline: none; color: var(--text-primary); font-size: 0.85rem; font-family: inherit; padding: 7px 12px; width: 140px; text-transform: uppercase; }
.add-input::placeholder { color: var(--text-muted); text-transform: none; }
.add-btn { background: none; border: none; border-left: 1px solid var(--border); color: #60a5fa; font-size: 0.8rem; font-weight: 700; padding: 7px 12px; cursor: pointer; font-family: inherit; transition: background 0.15s; }
.add-btn:hover { background: rgba(59,130,246,0.1); }
.selector-hint { font-size: 0.75rem; color: var(--text-muted); margin-top: 8px; }
.error-msg { font-size: 0.75rem; color: #f87171; margin-top: 6px; min-height: 18px; }

/* ── 차트 카드 ── */
.chart-card { padding: 22px 24px; margin-bottom: 16px; }
.card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px; }
.card-title { font-size: 0.78rem; font-weight: 700; letter-spacing: 0.06em; text-transform: uppercase; color: var(--text-muted); }
.chart-tabs { display: flex; gap: 4px; flex-wrap: wrap; }
.chart-tab { padding: 4px 12px; border-radius: 6px; font-size: 0.78rem; font-weight: 700; border: none; cursor: pointer; background: rgba(255,255,255,0.04); color: var(--text-muted); transition: all 0.15s; font-family: inherit; }
.chart-tab.active { background: rgba(59,130,246,0.15); color: #60a5fa; border: 1px solid rgba(59,130,246,0.3); }
.chart-tab:hover:not(.active) { color: var(--text-primary); background: rgba(255,255,255,0.07); }
.chart-container { width: 100%; height: 240px; overflow: hidden; }
.chart-legend { display: flex; gap: 20px; flex-wrap: wrap; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border); }
.legend-item { display: flex; align-items: center; gap: 6px; }
.legend-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
.legend-ticker { font-size: 0.82rem; font-weight: 800; }
.legend-link { font-size: 0.72rem; color: var(--text-muted); text-decoration: none; }
.legend-link:hover { color: #60a5fa; }
.legend-pct { font-size: 0.82rem; font-weight: 700; }
.empty-chart { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 240px; color: var(--text-muted); gap: 8px; }

/* ── 커스텀 기간 입력 ── */
.custom-range-row { display: flex; align-items: center; gap: 8px; margin: 10px 0 4px; flex-wrap: wrap; }
.range-label { font-size: 0.72rem; font-weight: 700; color: var(--text-muted); letter-spacing: 0.04em; white-space: nowrap; }
.range-input { background: rgba(255,255,255,0.04); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary); font-size: 0.78rem; padding: 4px 8px; font-family: inherit; outline: none; cursor: pointer; color-scheme: dark; }
.range-input:focus { border-color: rgba(59,130,246,0.5); }
.range-sep { color: var(--text-muted); font-size: 0.82rem; }
.range-error { font-size: 0.72rem; color: #f87171; min-height: 16px; margin-bottom: 6px; }

/* ── 비교 테이블 ── */
.table-card { padding: 22px 24px; margin-bottom: 16px; overflow-x: auto; }
.compare-table { width: 100%; border-collapse: collapse; min-width: 500px; }
.compare-table th { font-size: 0.8rem; font-weight: 700; padding: 10px 14px; text-align: center; border-bottom: 2px solid var(--border); }
.th-label { font-size: 0.72rem; color: var(--text-muted); text-align: left; font-weight: 600; }
.th-ticker-cell { min-width: 120px; }
.th-ticker-link { text-decoration: none; display: inline-flex; align-items: center; gap: 4px; padding: 4px 10px; border-radius: 6px; font-size: 0.88rem; font-weight: 900; border: 1px solid; transition: all 0.15s; }
.th-ticker-link:hover { filter: brightness(1.2); }
.group-row td { padding: 10px 14px 4px; font-size: 0.68rem; font-weight: 800; letter-spacing: 0.08em; text-transform: uppercase; color: var(--text-muted); background: rgba(255,255,255,0.01); border-top: 1px solid rgba(255,255,255,0.04); }
.data-row td { padding: 8px 14px; font-size: 0.84rem; border-bottom: 1px solid rgba(255,255,255,0.03); }
.data-row:last-child td { border-bottom: none; }
.metric-label-cell { font-size: 0.8rem; color: var(--text-muted); text-align: left; white-space: nowrap; }
.metric-note { font-size: 0.68rem; color: #334155; }
.data-cell { text-align: center; font-weight: 700; font-variant-numeric: tabular-nums; }
.cell-best { background: rgba(74,222,128,0.07); color: #4ade80 !important; border-radius: 4px; }
.cell-worst { color: #f87171 !important; }
.ret-pos { color: #4ade80; }
.ret-neg { color: #f87171; }
.ret-na  { color: #334155; }

/* ── 빈 상태 / 로딩 ── */
#loading-bar { height: 3px; background: linear-gradient(90deg, #3b82f6, #8b5cf6); position: fixed; top: 59px; left: 0; width: 0; z-index: 99; transition: width 0.4s ease; }
.placeholder-card { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 48px; color: var(--text-muted); gap: 12px; text-align: center; }

@media(max-width:700px) {
  .selector-row { flex-direction: column; align-items: flex-start; }
  .add-input { width: 120px; }
  .chart-legend { gap: 12px; }
}
</style>
</head>
<body>
<div class="gradient-line"></div>
<div id="loading-bar"></div>

<nav>
  <div class="nav-inner">
    <a href="/index" class="nav-back">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M19 12H5M12 5l-7 7 7 7"/></svg>
      <span data-i18n="nav.dashboard">대시보드</span>
    </a>
    <span style="color:#1e293b">/</span>
    <a href="/landing" style="font-size:0.95rem;font-weight:900;text-decoration:none"><span class="text-gradient">CORRYU</span></a>
    <span style="font-size:0.82rem;color:var(--text-muted)" data-i18n="nav.breadcrumb.compare">/ ETF 비교</span>
    <a href="/screener"    style="margin-left:auto;font-size:0.78rem;color:var(--text-muted);text-decoration:none;font-weight:600;display:flex;align-items:center;gap:4px">
      <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg><span data-i18n="nav.screener">스크리너</span></a>
    <a href="/backtest"    style="font-size:0.78rem;color:var(--text-muted);text-decoration:none;font-weight:600;display:flex;align-items:center;gap:4px">
      <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg><span data-i18n="nav.backtest">백테스트</span></a>
    <a href="/correlation" style="font-size:0.78rem;color:var(--text-muted);text-decoration:none;font-weight:600;display:flex;align-items:center;gap:4px">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="8" cy="8" r="2"/><circle cx="16" cy="8" r="2"/><circle cx="12" cy="16" r="2"/><line x1="10" y1="8" x2="14" y2="8"/><line x1="9" y1="10" x2="11" y2="14"/><line x1="15" y1="10" x2="13" y2="14"/></svg>
      <span data-i18n="nav.correlation">상관관계</span>
    </a>
    <a href="/portfolio" style="font-size:0.78rem;color:var(--text-muted);text-decoration:none;font-weight:600;display:flex;align-items:center;gap:4px">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 7V5a2 2 0 00-2-2h-4a2 2 0 00-2 2v2"/></svg>
      <span data-i18n="nav.portfolio">포트폴리오</span>
    </a>
  </div>
</nav>

<div class="main-wrap">

  <!-- ── Ticker 선택 ── -->
  <div class="glass selector-card">
    <div class="selector-title" data-i18n-html="compare.title">ETF <span class="text-gradient">비교</span></div>
    <div class="selector-row" id="chip-row">
      <!-- chips injected here -->
      <div class="add-input-wrap" id="add-wrap">
        <input type="text" class="add-input" id="add-input" data-i18n-placeholder="compare.add.placeholder" placeholder="티커 입력 (예: QQQ 또는 QQQ SPY SOXX)" maxlength="20" autocomplete="off">
        <button class="add-btn" onclick="addTicker()" data-i18n="compare.add.btn">+ 추가</button>
      </div>
    </div>
    <div class="error-msg" id="error-msg"></div>
    <div class="selector-hint" data-i18n="compare.hint">최대 3개 ETF를 선택해 나란히 비교합니다. CORRYU 데이터베이스에 있는 ETF만 추가 가능합니다.</div>
  </div>

  <!-- ── 비교 차트 ── -->
  <div class="glass chart-card" id="chart-card">
    <div class="card-header">
      <div class="card-title" data-i18n="compare.chart.title">수익률 비교 차트 (시뮬레이션)</div>
      <div class="chart-tabs">
        <button class="chart-tab" onclick="switchPeriod('1M',this)" data-i18n="period.1M">1개월</button>
        <button class="chart-tab" onclick="switchPeriod('3M',this)" data-i18n="period.3M">3개월</button>
        <button class="chart-tab" onclick="switchPeriod('6M',this)" data-i18n="period.6M">6개월</button>
        <button class="chart-tab active" onclick="switchPeriod('1Y',this)" data-i18n="period.1Y">1년</button>
        <button class="chart-tab" onclick="switchPeriod('3Y',this)" data-i18n="period.3Y">3년</button>
        <button class="chart-tab" onclick="switchPeriod('5Y',this)" data-i18n="period.5Y">5년</button>
        <button class="chart-tab" onclick="switchPeriod('10Y',this)" data-i18n="period.10Y">10년</button>
        <button class="chart-tab" onclick="switchPeriod('15Y',this)" data-i18n="period.15Y">15년</button>
        <button class="chart-tab" onclick="switchPeriod('20Y',this)" data-i18n="period.20Y">20년</button>
      </div>
    </div>
    <div class="custom-range-row">
      <span class="range-label" data-i18n="compare.custom.range">직접 설정</span>
      <input type="date" id="date-start" class="range-input" onchange="applyCustomRange()">
      <span class="range-sep">~</span>
      <input type="date" id="date-end" class="range-input" onchange="applyCustomRange()">
    </div>
    <div class="range-error" id="range-error"></div>
    <div class="chart-container" id="chart-container">
      <div class="empty-chart">
        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" opacity="0.3"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
        <span style="font-size:0.85rem" data-i18n="compare.empty.chart">ETF를 선택하면 차트가 표시됩니다</span>
      </div>
    </div>
    <div class="chart-legend" id="chart-legend"></div>
    <div style="font-size:0.68rem;color:#64748b;margin-top:6px;text-align:right">※ 수정주가(adj_close) 기준 기간 누적 수익률</div>
  </div>

  <!-- ── 비교 테이블 ── -->
  <div class="glass table-card" id="table-card">
    <div class="card-title" style="margin-bottom:16px" data-i18n="compare.table.title">상세 지표 비교</div>
    <div id="table-container">
      <div class="placeholder-card">
        <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" opacity="0.2"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="21" x2="9" y2="3"/></svg>
        <span style="font-size:0.85rem" data-i18n="compare.empty.table">2개 이상 ETF를 선택하면 비교 테이블이 표시됩니다</span>
      </div>
    </div>
  </div>

</div><!-- /main-wrap -->

<script>
// ── ETF 색상 팔레트 ──────────────────────────────────
const ETF_COLORS = ['#3b82f6','#a78bfa','#f59e0b'];
const ETF_COLORS_CHIP = ['chip-0','chip-1','chip-2'];

// ── 보조 데이터 ──────────────────────────────────────
const SUPP = {
  'SPY':  { exp:'0.09%',  issuer:'State Street',        bench:'S&P 500',        numH:503,  div:'분기', divY:'1.24%', perf:{'1Y':22.4,'3Y':12.1,'5Y':14.7} },
  'QQQ':  { exp:'0.20%',  issuer:'Invesco',              bench:'Nasdaq-100',     numH:101,  div:'분기', divY:'0.55%', perf:{'1Y':28.5,'3Y':15.4,'5Y':19.2} },
  'IVV':  { exp:'0.03%',  issuer:'BlackRock',            bench:'S&P 500',        numH:503,  div:'분기', divY:'1.26%', perf:{'1Y':22.4,'3Y':12.1,'5Y':14.7} },
  'VOO':  { exp:'0.03%',  issuer:'Vanguard',             bench:'S&P 500',        numH:503,  div:'분기', divY:'1.25%', perf:{'1Y':22.3,'3Y':12.0,'5Y':14.6} },
  'VTI':  { exp:'0.03%',  issuer:'Vanguard',             bench:'CRSP US Total',  numH:3615, div:'분기', divY:'1.35%', perf:{'1Y':21.8,'3Y':11.7,'5Y':14.3} },
  'GLD':  { exp:'0.40%',  issuer:'State Street',         bench:'Gold Price',     numH:1,    div:'없음', divY:'0%',    perf:{'1Y':18.7,'3Y':8.3, '5Y':11.2} },
  'TLT':  { exp:'0.15%',  issuer:'BlackRock',            bench:'UST 20+Y',       numH:26,   div:'월',   divY:'4.12%', perf:{'1Y':-8.3,'3Y':-12.4,'5Y':-6.8} },
  'XLK':  { exp:'0.09%',  issuer:'State Street',         bench:'S&P Tech',       numH:67,   div:'분기', divY:'0.68%', perf:{'1Y':34.2,'3Y':18.6,'5Y':22.8} },
  'XLF':  { exp:'0.09%',  issuer:'State Street',         bench:'S&P Financials', numH:72,   div:'분기', divY:'1.68%', perf:{'1Y':18.4,'3Y':10.2,'5Y':12.1} },
  'XLV':  { exp:'0.09%',  issuer:'State Street',         bench:'S&P Healthcare', numH:63,   div:'분기', divY:'1.42%', perf:{'1Y':10.2,'3Y':8.4, '5Y':10.8} },
  'XLE':  { exp:'0.09%',  issuer:'State Street',         bench:'S&P Energy',     numH:22,   div:'분기', divY:'3.42%', perf:{'1Y':4.2, '3Y':22.4,'5Y':16.8} },
  'IWM':  { exp:'0.19%',  issuer:'BlackRock',            bench:'Russell 2000',   numH:2000, div:'분기', divY:'1.23%', perf:{'1Y':14.2,'3Y':6.4, '5Y':9.1}  },
  'VEA':  { exp:'0.05%',  issuer:'Vanguard',             bench:'FTSE Dev ex US', numH:3900, div:'반기', divY:'2.98%', perf:{'1Y':10.4,'3Y':5.2, '5Y':7.8}  },
  'VWO':  { exp:'0.08%',  issuer:'Vanguard',             bench:'FTSE EM',        numH:5600, div:'반기', divY:'3.42%', perf:{'1Y':8.4, '3Y':2.1, '5Y':4.8}  },
  'VNQ':  { exp:'0.13%',  issuer:'Vanguard',             bench:'MSCI US RE',     numH:163,  div:'분기', divY:'3.85%', perf:{'1Y':12.3,'3Y':2.8, '5Y':7.4}  },
  'HYG':  { exp:'0.48%',  issuer:'BlackRock',            bench:'iBoxx HY',       numH:1195, div:'월',   divY:'5.82%', perf:{'1Y':8.7, '3Y':4.2, '5Y':4.8}  },
  'BND':  { exp:'0.03%',  issuer:'Vanguard',             bench:'Bloomberg Agg',  numH:10418,div:'월',   divY:'3.72%', perf:{'1Y':2.3, '3Y':-1.8,'5Y':0.4}  },
  'GBTC': { exp:'1.50%',  issuer:'Grayscale',            bench:'Bitcoin',        numH:1,    div:'없음', divY:'0%',    perf:{'1Y':124.3,'3Y':28.4,'5Y':48.7} },
  'SQQQ': { exp:'0.95%',  issuer:'ProShares',            bench:'QQQ × −3',       numH:0,    div:'분기', divY:'3.21%', perf:{'1Y':-67.4,'3Y':-42.8,'5Y':-51.3} },
  'PEY':  { exp:'0.53%',  issuer:'Invesco',              bench:'Dividend Achievers 50', numH:50, div:'월', divY:'4.87%', perf:{'1Y':8.4,'3Y':4.2,'5Y':7.8} },
  'IWF':  { exp:'0.19%',  issuer:'BlackRock',            bench:'Russell 1000 Growth', numH:415, div:'분기', divY:'0.52%', perf:{'1Y':32.4,'3Y':16.8,'5Y':20.4} },
};

// ── 데이터 ────────────────────────────────────────────
let allData = {};     // ticker → etf object (flattened from etf_data.json)
let selectedETFs = []; // ordered list of etf objects
let currentPeriod = '1Y';
let customRange = null; // { start: 'YYYY-MM-DD', end: 'YYYY-MM-DD' } | null

// ── 날짜 입력 max 설정 (미래 날짜 선택 방지) ─────────
(function() {
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('date-start').max = today;
  document.getElementById('date-end').max   = today;
})();

// ── URL 파라미터에서 초기 tickers 로드 ──────────────
const urlParams = new URLSearchParams(location.search);
const initTickers = (urlParams.get('tickers') || '').split(',').map(t => t.trim().toUpperCase()).filter(Boolean).slice(0,3);

// ── 실가격 히스토리 (Supabase) ────────────────────────
let lwCompareChart = null;
let compareSeriesMap = {};      // { ticker: LW series }
let priceHistoryCache = {};     // { ticker: [{date, adj_close}] }

async function loadCompareHistory(ticker) {
  if (priceHistoryCache[ticker]) return priceHistoryCache[ticker];
  if (!window._sb) return null;
  const { data, error } = await window._sb
    .from('etf_prices')
    .select('date, adj_close')
    .eq('ticker', ticker)
    .order('date', { ascending: true })
    .limit(10000);
  if (!error && data && data.length >= 5) {
    priceHistoryCache[ticker] = data;
    return data;
  }
  return null;
}
function getPeriodStartStr() {
  if (customRange) return customRange.start;
  const calDays = Math.round((PERIOD_DAYS[currentPeriod] || 252) * 365 / 252);
  const d = new Date(); d.setDate(d.getDate() - calDays);
  return d.toISOString().split('T')[0];
}
function normalizeSeries(history, fromDate) {
  const filtered = history.filter(d => d.date >= fromDate);
  if (filtered.length < 2) return null;
  const base = filtered[0].adj_close;
  return filtered.map(d => ({ time: d.date, value: (d.adj_close / base - 1) * 100 }));
}

// ── 포맷 헬퍼 ─────────────────────────────────────────
function fmtAUM(v) { if(!v) return '—'; const m=v/1e6; return m>=1000?'$'+(m/1000).toFixed(1)+'B':'$'+Math.round(m)+'M'; }
function fmtPct(v,d=1) { if(v===null||v===undefined) return '—'; return (v>0?'+':'')+v.toFixed(d)+'%'; }
function fmtNum(v,d=2) { if(v===null||v===undefined) return '—'; return v.toFixed(d); }
function parseExp(str) { if(!str||str==='—') return null; return parseFloat(str.replace('%','').replace(',',''))||null; }

// ── 비교 지표 정의 ────────────────────────────────────
// { label, get(etf,supp), best:'max'|'min'|'none', fmtClass(v):'ret-pos'|'ret-neg'|'', note }
const METRIC_GROUPS = [
  { group: () => I18n.t('compare.group.info'), metrics: [
    { label: 'AUM',        get:(e,s)=>fmtAUM(e.aum),      raw:(e)=>e.aum||0,              best:'max',  note:()=>I18n.t('compare.note.aum') },
    { label: ()=>I18n.t('compare.metric.expense'), get:(e,s)=>s.exp||'—', raw:(e,s)=>parseExp(s.exp)||999, best:'min', note:()=>I18n.t('compare.note.expense') },
    { label: ()=>I18n.t('compare.metric.issuer'),  get:(e,s)=>s.issuer||'—', raw:null, best:'none' },
    { label: ()=>I18n.t('compare.metric.benchmark'), get:(e,s)=>s.bench||'—', raw:null, best:'none' },
    { label: ()=>I18n.t('col.inception'),          get:(e,s)=>e.inception&&e.inception!=='1900-01-01'?e.inception:'—', raw:null, best:'none' },
    { label: ()=>I18n.t('compare.metric.holdings'), get:(e,s)=>s.numH!==undefined?s.numH.toLocaleString()+I18n.t('compare.holdings.unit',{n:''}).trim():'—', raw:null, best:'none' },
    { label: ()=>I18n.t('compare.metric.div.freq'),  get:(e,s)=>s.div||'—', raw:null, best:'none' },
    { label: ()=>I18n.t('compare.metric.div.yield'), get:(e,s)=>s.divY||'—', raw:(e,s)=>parseFloat((s.divY||'0').replace('%',''))||0, best:'max', note:()=>I18n.t('compare.note.div') },
  ]},
  { group: () => I18n.t('compare.group.return'), metrics: [
    { label: ()=>I18n.t('compare.metric.cagr'),  get:(e,s)=>fmtPct(e.cagr),           raw:(e)=>e.cagr??-999,         best:'max', fmtClass:v=>v>=0?'ret-pos':'ret-neg', note:()=>I18n.t('compare.note.cagr') },
    { label: ()=>I18n.t('compare.metric.ret1y'), get:(e,s)=>fmtPct(s.perf?.['1Y']),    raw:(e,s)=>s.perf?.['1Y']??-999, best:'max', fmtClass:v=>v>=0?'ret-pos':'ret-neg' },
    { label: ()=>I18n.t('compare.metric.ret3y'), get:(e,s)=>fmtPct(s.perf?.['3Y']),   raw:(e,s)=>s.perf?.['3Y']??-999, best:'max', fmtClass:v=>v>=0?'ret-pos':'ret-neg' },
    { label: ()=>I18n.t('compare.metric.ret5y'), get:(e,s)=>fmtPct(s.perf?.['5Y']),   raw:(e,s)=>s.perf?.['5Y']??-999, best:'max', fmtClass:v=>v>=0?'ret-pos':'ret-neg' },
  ]},
  { group: () => I18n.t('compare.group.risk'), metrics: [
    { label: ()=>I18n.t('compare.metric.vol'),  get:(e,s)=>fmtPct(e.vol),     raw:(e)=>e.vol??999,         best:'min', fmtClass:v=>v<15?'ret-pos':'', note:()=>I18n.t('compare.note.vol') },
    { label: '52W MDD',                          get:(e,s)=>fmtPct(e.mdd_52w), raw:(e)=>e.mdd_52w??-999,    best:'max', fmtClass:v=>v<-20?'ret-neg':'', note:()=>I18n.t('compare.note.mdd') },
    { label: 'Sortino',                          get:(e,s)=>fmtNum(e.sortino,2),raw:(e)=>e.sortino??-999,    best:'max', fmtClass:v=>v>=1.2?'ret-pos':v<0?'ret-neg':'', note:()=>I18n.t('compare.note.sortino') },
  ]},
  { group: () => I18n.t('compare.group.corryu'), metrics: [
    { label: 'Z-Score',      get:(e,s)=>e.short_history?I18n.t('compare.short.history'):fmtNum(e.z_score,2), raw:(e)=>e.short_history?null:e.z_score, best:'none', fmtClass:v=>v>2?'ret-neg':v<-1.5?'ret-pos':'' },
    { label: ()=>I18n.t('compare.metric.zscore')==='Z-Score'?'RSI (14d)':'RSI (14일)', get:(e,s)=>fmtNum(e.rsi,0), raw:(e)=>e.rsi??null, best:'none', fmtClass:v=>v>70?'ret-neg':v<30?'ret-pos':'' },
    { label: '52W Range',    get:(e,s)=>fmtNum(e.range_52w,0)+'%', raw:(e)=>e.range_52w??null, best:'none' },
    { label: ()=>I18n.t('compare.metric.ma200'), get:(e,s)=>e.short_history?'—':fmtPct(e.ma200_pct), raw:(e)=>e.short_history?null:e.ma200_pct, best:'none' },
    { label: 'r_Anchor',     get:(e,s)=>fmtNum(e.r_anchor,2), raw:(e)=>e.r_anchor??null, best:'none' },
    { label: 'SMH Corr',     get:(e,s)=>e.smh_corr!==null&&e.smh_corr!==undefined?fmtNum(e.smh_corr,2):'—', raw:(e)=>e.smh_corr, best:'none' },
  ]},
];

// ── 칩 + URL 업데이트 ─────────────────────────────────
function updateURL() {
  const tickers = selectedETFs.map(e => e.ticker).join(',');
  const url = tickers ? '/compare?tickers='+encodeURIComponent(tickers) : '/compare';
  history.replaceState(null,'',url);
}

function renderChips() {
  const row = document.getElementById('chip-row');
  // Remove old chips
  row.querySelectorAll('.ticker-chip').forEach(el => el.remove());
  const addWrap = document.getElementById('add-wrap');

  selectedETFs.forEach((etf, idx) => {
    const chip = document.createElement('div');
    chip.className = 'ticker-chip ' + ETF_COLORS_CHIP[idx];
    chip.innerHTML = `<span>${etf.ticker}</span><button class="chip-close" title="제거" onclick="removeTicker('${etf.ticker}')">✕</button>`;
    row.insertBefore(chip, addWrap);
  });

  // Hide add input if 3 already selected
  addWrap.style.display = selectedETFs.length >= 3 ? 'none' : 'flex';
}

function showError(msg) {
  const el = document.getElementById('error-msg');
  el.textContent = msg;
  setTimeout(() => { el.textContent = ''; }, 3000);
}

function addTicker() {
  const input = document.getElementById('add-input');
  const raw = input.value.trim().toUpperCase();
  if (!raw) return;
  input.value = '';
  // 구분자: 쉼표 / 슬래시 / 세미콜론 / 파이프 / 공백 (조합·연속 허용)
  // 구분자 없는 단일 문자열(예: QQQQLDSPY)은 분리하지 않음
  const tokens = raw.split(/[,\/;|\s]+/).filter(Boolean);
  for (const t of tokens) {
    if (selectedETFs.length >= 3) { showError(I18n.t('compare.error.max')); break; }
    if (selectedETFs.some(e => e.ticker === t)) { showError(I18n.t('compare.error.dup', {t})); continue; }
    const found = allData[t];
    if (!found) { showError(I18n.t('compare.error.notfound', {t})); continue; }
    selectedETFs.push(found);
  }
  updateURL();
  renderChips();
  renderAll();
}

function removeTicker(ticker) {
  selectedETFs = selectedETFs.filter(e => e.ticker !== ticker);
  updateURL();
  renderChips();
  renderAll();
}

// ── 차트 렌더링 ───────────────────────────────────────
const PERIOD_DAYS = {
  '1M':22, '3M':65, '6M':130, '1Y':252,
  '3Y':756, '5Y':1260, '10Y':2520, '15Y':3780, '20Y':5040
};

// 기간 프리셋의 시작일 계산 (상장일 비교용)
function getPeriodStartDate(period) {
  const d = new Date();
  if (period.endsWith('M')) d.setMonth(d.getMonth() - parseInt(period));
  else if (period.endsWith('Y')) d.setFullYear(d.getFullYear() - parseInt(period));
  return d;
}

// 커스텀/프리셋에 따라 n(거래일 수) 반환
function getChartDays() {
  if (customRange) {
    const ms = new Date(customRange.end) - new Date(customRange.start);
    return Math.max(Math.round(ms / 86400000 * 252 / 365), 2);
  }
  return PERIOD_DAYS[currentPeriod] || 252;
}

// 상장일 초과 여부 체크 → range-error 표시
function checkInceptionError() {
  const el = document.getElementById('range-error');
  if (!el) return;
  if (selectedETFs.length === 0) { el.textContent = ''; return; }

  const startDate = customRange ? new Date(customRange.start) : getPeriodStartDate(currentPeriod);
  const errors = [];
  for (const etf of selectedETFs) {
    if (etf.inception && etf.inception !== '1900-01-01') {
      const inc = new Date(etf.inception);
      if (startDate < inc) {
        errors.push(I18n.t('compare.inception.error', {ticker: etf.ticker, date: etf.inception}));
      }
    }
  }
  el.textContent = errors.length ? I18n.t('compare.error.inception', {errors: errors.join(', ')}) : '';
}

function switchPeriod(period, el) {
  document.querySelectorAll('.chart-tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  currentPeriod = period;
  customRange = null;
  document.getElementById('date-start').value = '';
  document.getElementById('date-end').value = '';
  renderChart();
}

// 직접 날짜 입력 적용
function applyCustomRange() {
  const start = document.getElementById('date-start').value;
  const end   = document.getElementById('date-end').value;
  const errEl = document.getElementById('range-error');
  if (!start || !end) return;
  if (new Date(end) <= new Date(start)) {
    errEl.textContent = I18n.t('compare.error.dateorder');
    return;
  }
  document.querySelectorAll('.chart-tab').forEach(t => t.classList.remove('active'));
  customRange = { start, end };
  renderChart();
}

async function renderChart() {
  const container = document.getElementById('chart-container');
  const legend    = document.getElementById('chart-legend');
  checkInceptionError();

  if (selectedETFs.length === 0) {
    if (lwCompareChart) { lwCompareChart.remove(); lwCompareChart = null; compareSeriesMap = {}; }
    container.innerHTML = `<div class="empty-chart"><svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" opacity="0.3"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg><span style="font-size:0.85rem">${I18n.t('compare.empty.chart')}</span></div>`;
    legend.innerHTML = '';
    return;
  }

  // Init LW Chart on first call
  if (!lwCompareChart) {
    container.innerHTML = '';
    lwCompareChart = LightweightCharts.createChart(container, {
      width:  container.clientWidth,
      height: 240,
      layout: { background: { type: 'solid', color: 'transparent' }, textColor: '#94a3b8' },
      grid:   { vertLines: { color: 'rgba(148,163,184,0.1)' }, horzLines: { color: 'rgba(148,163,184,0.1)' } },
      rightPriceScale: { borderColor: 'rgba(148,163,184,0.2)' },
      timeScale: { borderColor: 'rgba(148,163,184,0.2)', timeVisible: false },
      crosshair: { mode: 1 },
    });
    window.addEventListener('resize', () => {
      if (lwCompareChart) lwCompareChart.applyOptions({ width: container.clientWidth });
    });
  }

  // Remove old series
  Object.values(compareSeriesMap).forEach(s => { try { lwCompareChart.removeSeries(s); } catch(e) {} });
  compareSeriesMap = {};

  const fromDate = getPeriodStartStr();
  const today    = new Date().toISOString().split('T')[0];

  // Load all price histories in parallel
  const histories = await Promise.all(selectedETFs.map(e => loadCompareHistory(e.ticker)));

  legend.innerHTML = '';
  selectedETFs.forEach((etf, i) => {
    const history = histories[i];
    if (!history) return;
    const normalized = normalizeSeries(history, fromDate);
    if (!normalized || normalized.length < 2) return;

    const color  = ETF_COLORS[i];
    const series = lwCompareChart.addLineSeries({ color, lineWidth: 2,
      priceFormat: { type: 'custom', formatter: v => (v >= 0 ? '+' : '') + v.toFixed(1) + '%' },
    });
    series.setData(normalized);
    compareSeriesMap[etf.ticker] = series;

    const lastPct = normalized[normalized.length - 1].value;
    const isUp    = lastPct >= 0;
    legend.innerHTML += `<div class="legend-item">
      <div class="legend-dot" style="background:${color}"></div>
      <a href="/etf-detail?ticker=${etf.ticker}" class="legend-link"><span class="legend-ticker" style="color:${color}">${etf.ticker}</span></a>
      <span class="legend-pct ${isUp ? 'ret-pos' : 'ret-neg'}">${isUp ? '+' : ''}${lastPct.toFixed(1)}%</span>
    </div>`;
  });

  if (Object.keys(compareSeriesMap).length > 0) {
    lwCompareChart.timeScale().setVisibleRange({ from: fromDate, to: today });
  }
}

// ── 비교 테이블 렌더링 ───────────────────────────────
function renderTable() {
  const container = document.getElementById('table-container');
  if (selectedETFs.length < 2) {
    container.innerHTML = `<div class="placeholder-card"><svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" opacity="0.2"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="21" x2="9" y2="3"/></svg><span style="font-size:0.85rem">${I18n.t('compare.empty.table')}</span></div>`;
    return;
  }

  const supps = selectedETFs.map(e => SUPP[e.ticker] || {});
  const N = selectedETFs.length;

  // Header row
  const thCells = selectedETFs.map((e,i) => {
    const col = ETF_COLORS[i];
    return `<th class="th-ticker-cell"><a href="/etf-detail?ticker=${e.ticker}" class="th-ticker-link" style="color:${col};border-color:${col}22;background:${col}11">${e.ticker} <span style="font-size:0.65rem;opacity:0.6">↗</span></a></th>`;
  }).join('');

  // Body rows
  let bodyHtml = '';
  METRIC_GROUPS.forEach(grp => {
    bodyHtml += `<tr class="group-row"><td colspan="${N+1}">${typeof grp.group === 'function' ? grp.group() : grp.group}</td></tr>`;
    grp.metrics.forEach(m => {
      const displays = selectedETFs.map((e,i) => m.get(e, supps[i]));
      const raws     = m.raw ? selectedETFs.map((e,i) => m.raw(e, supps[i])) : null;

      // Determine best/worst indices
      let bestIdx = -1, worstIdx = -1;
      if (m.best !== 'none' && raws) {
        const validRaws = raws.filter(v => v !== null && v !== undefined && v !== -999 && v !== 999);
        if (validRaws.length >= 2) {
          const bestVal  = m.best === 'max' ? Math.max(...validRaws) : Math.min(...validRaws);
          const worstVal = m.best === 'max' ? Math.min(...validRaws) : Math.max(...validRaws);
          bestIdx  = raws.indexOf(bestVal);
          worstIdx = raws.indexOf(worstVal);
          if (bestIdx === worstIdx) worstIdx = -1;
        }
      }

      const cells = displays.map((d, i) => {
        const isBest  = i === bestIdx;
        const isWorst = i === worstIdx;
        let cls = 'data-cell';
        if (isBest)  cls += ' cell-best';
        if (isWorst) cls += ' cell-worst';
        // color class from fmtClass
        if (m.fmtClass && raws && raws[i] !== null) {
          const extra = m.fmtClass(raws[i]);
          if (extra && !isBest && !isWorst) cls += ' ' + extra;
        }
        const badge = isBest ? ` <span style="font-size:0.62rem;opacity:0.7">${I18n.t('compare.badge.best')}</span>` : '';
        return `<td class="${cls}">${d}${badge}</td>`;
      }).join('');

      const noteHtml = m.note ? `<div class="metric-note">${typeof m.note === 'function' ? m.note() : m.note}</div>` : '';
      const labelStr = typeof m.label === 'function' ? m.label() : m.label;
      bodyHtml += `<tr class="data-row"><td class="metric-label-cell">${labelStr}${noteHtml}</td>${cells}</tr>`;
    });
  });

  container.innerHTML = `<table class="compare-table">
    <thead><tr><th class="th-label">${I18n.t('compare.table.metric')}</th>${thCells}</tr></thead>
    <tbody>${bodyHtml}</tbody>
  </table>`;
}

async function renderAll() {
  await renderChart();
  renderTable();
}

// ── 데이터 로드 ───────────────────────────────────────
const loadingBar = document.getElementById('loading-bar');
loadingBar.style.width = '40%';

fetch('/etf_data.json')
  .then(r => r.json())
  .then(data => {
    // Flatten all sectors → allData[ticker] = etf
    for (const [, etfs] of Object.entries(data.allData || data)) {
      if (!Array.isArray(etfs)) continue;
      for (const etf of etfs) { allData[etf.ticker] = etf; }
    }
    loadingBar.style.width = '100%';
    setTimeout(() => { loadingBar.style.width = '0'; loadingBar.style.transition = 'none'; }, 400);

    // Load overrides
    const ov = JSON.parse(localStorage.getItem('corryu_user_overrides') || '{}');
    for (const [t, o] of Object.entries(ov)) {
      if (allData[t] && 'is_legacy' in o) { allData[t].is_legacy = o.is_legacy; }
    }

    // Load initial tickers from URL
    initTickers.forEach(t => {
      if (allData[t] && !selectedETFs.some(e => e.ticker === t)) {
        selectedETFs.push(allData[t]);
      }
    });
    renderChips();
    renderAll();
    I18n.init();
  })
  .catch(() => { showError(I18n.t('compare.error.load')); });

// ── 입력 이벤트 ───────────────────────────────────────
document.getElementById('add-input').addEventListener('keydown', e => {
  if (e.key === 'Enter') addTicker();
});

// 언어 변경 시 동적으로 생성된 텍스트 재렌더링
document.addEventListener('i18n:ready', () => { renderAll(); });
</script>
</body>
</html>
